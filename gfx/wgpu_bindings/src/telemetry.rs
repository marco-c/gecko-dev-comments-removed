



use firefox_on_glean::metrics::webgpu;



pub fn build_telemetry_struct() -> wgh::Telemetry {
    wgh::Telemetry {
        #[cfg(target_os = "windows")]
        d3d12_expose_adapter,
    }
}

#[cfg(target_os = "windows")]
fn d3d12_expose_adapter(
    desc: &windows::Win32::Graphics::Dxgi::DXGI_ADAPTER_DESC2,
    driver_version: [u16; 4],
    result: wgh::D3D12ExposeAdapterResult,
) {
    
    
    
    
    
    
    let key = &format!(
        "D:{:X}:{:X}:{:X}:{:X}:{}.{}.{}.{}",
        desc.VendorId,
        desc.DeviceId,
        desc.SubSysId,
        desc.Revision,
        driver_version[0],
        driver_version[1],
        driver_version[2],
        driver_version[3],
    );
    let category = match result {
        wgh::D3D12ExposeAdapterResult::CreateDeviceError(err) => match err {
            wgh::dx12::CreateDeviceError::GetProcAddress => "NONE:GetProcAddress",
            wgh::dx12::CreateDeviceError::D3D12CreateDevice(hresult) => {
                &format!("NONE:D3D12CreateDevice:{:X}", hresult.0)
            }
            wgh::dx12::CreateDeviceError::RetDeviceIsNull => "NONE:RetDeviceIsNull",
        },
        wgh::D3D12ExposeAdapterResult::ResourceBindingTier2Requirement => "NONE:REQ_RBT2",
        wgh::D3D12ExposeAdapterResult::ShaderModel6Requirement => "NONE:REQ_SM6",
        wgh::D3D12ExposeAdapterResult::Success(feature_level, shader_model) => {
            let feature_level = match feature_level {
                wgh::dx12::FeatureLevel::_11_0 => "11_0",
                wgh::dx12::FeatureLevel::_11_1 => "11_1",
                wgh::dx12::FeatureLevel::_12_0 => "12_0",
                wgh::dx12::FeatureLevel::_12_1 => "12_1",
                wgh::dx12::FeatureLevel::_12_2 => "12_2",
            };
            let shader_model = match shader_model {
                wgh::dx12::ShaderModel::_5_1 => "5.1",
                wgh::dx12::ShaderModel::_6_0 => "6.0",
                wgh::dx12::ShaderModel::_6_1 => "6.1",
                wgh::dx12::ShaderModel::_6_2 => "6.2",
                wgh::dx12::ShaderModel::_6_3 => "6.3",
                wgh::dx12::ShaderModel::_6_4 => "6.4",
                wgh::dx12::ShaderModel::_6_5 => "6.5",
                wgh::dx12::ShaderModel::_6_6 => "6.6",
                wgh::dx12::ShaderModel::_6_7 => "6.7",
                wgh::dx12::ShaderModel::_6_8 => "6.8",
                wgh::dx12::ShaderModel::_6_9 => "6.9",
            };
            &format!("SOME:FL{feature_level}:SM{shader_model}")
        }
    };
    webgpu::expose_adapter.get(key, category).add(1);
}
