From: Michael Froman <mfroman@mozilla.com>
Date: Mon, 29 Dec 2025 00:29:00 +0000
Subject: Bug xxx - rollup of rid fixes to reviewed on moz-central

Mercurial Revision: https://hg.mozilla.org/mozilla-central/rev/2354aad0aa3f89e83570f597e616783e97cf00c8
---
 api/frame_transformer_interface.h             |  4 +-
 api/test/mock_transformable_video_frame.h     |  1 +
 modules/rtp_rtcp/source/rtp_sender.h          |  4 +-
 ...sender_video_frame_transformer_delegate.cc | 17 ++++----
 ..._sender_video_frame_transformer_delegate.h |  3 +-
 ...deo_frame_transformer_delegate_unittest.cc | 41 +++++++++++++------
 .../source/rtp_sender_video_unittest.cc       |  4 +-
 ...eam_receiver_frame_transformer_delegate.cc |  5 ---
 ...ver_frame_transformer_delegate_unittest.cc |  1 +
 9 files changed, 47 insertions(+), 33 deletions(-)

diff --git a/api/frame_transformer_interface.h b/api/frame_transformer_interface.h
index 4d34eb4bae..cc90244338 100644
--- a/api/frame_transformer_interface.h
+++ b/api/frame_transformer_interface.h
@@ -114,10 +114,8 @@ class TransformableVideoFrameInterface : public TransformableFrameInterface {
   RTC_EXPORT explicit TransformableVideoFrameInterface(Passkey passkey);
   virtual ~TransformableVideoFrameInterface() = default;
   virtual bool IsKeyFrame() const = 0;
-  virtual const std::string& GetRid() const = 0;
-
+  virtual std::optional<std::string> Rid() const { return std::nullopt; }
   virtual VideoFrameMetadata Metadata() const = 0;
-
   virtual void SetMetadata(const VideoFrameMetadata&) = 0;
 };
 
diff --git a/api/test/mock_transformable_video_frame.h b/api/test/mock_transformable_video_frame.h
index 2f6fd63178..2529dcca66 100644
--- a/api/test/mock_transformable_video_frame.h
+++ b/api/test/mock_transformable_video_frame.h
@@ -34,6 +34,7 @@ class MockTransformableVideoFrame : public TransformableVideoFrameInterface {
   MOCK_METHOD(void, SetRTPTimestamp, (uint32_t), (override));
   MOCK_METHOD(uint32_t, GetSsrc, (), (const, override));
   MOCK_METHOD(bool, IsKeyFrame, (), (const, override));
+  MOCK_METHOD(std::optional<std::string>, Rid, (), (const, override));
   MOCK_METHOD(void, SetMetadata, (const VideoFrameMetadata&), (override));
   MOCK_METHOD(uint8_t, GetPayloadType, (), (const, override));
   MOCK_METHOD(bool, CanSetPayloadType, (), (const, override));
diff --git a/modules/rtp_rtcp/source/rtp_sender.h b/modules/rtp_rtcp/source/rtp_sender.h
index 2c900dde28..5535a4061c 100644
--- a/modules/rtp_rtcp/source/rtp_sender.h
+++ b/modules/rtp_rtcp/source/rtp_sender.h
@@ -140,9 +140,7 @@ class RTPSender {
 
   uint32_t SSRC() const RTC_LOCKS_EXCLUDED(send_mutex_) { return ssrc_; }
 
-  const std::string& Rid() const RTC_LOCKS_EXCLUDED(send_mutex_) {
-    return rid_;
-  }
+  std::string Rid() const RTC_LOCKS_EXCLUDED(send_mutex_) { return rid_; }
 
   std::optional<uint32_t> FlexfecSsrc() const RTC_LOCKS_EXCLUDED(send_mutex_) {
     return flexfec_ssrc_;
diff --git a/modules/rtp_rtcp/source/rtp_sender_video_frame_transformer_delegate.cc b/modules/rtp_rtcp/source/rtp_sender_video_frame_transformer_delegate.cc
index 001a873e20..eaff69eb75 100644
--- a/modules/rtp_rtcp/source/rtp_sender_video_frame_transformer_delegate.cc
+++ b/modules/rtp_rtcp/source/rtp_sender_video_frame_transformer_delegate.cc
@@ -57,7 +57,7 @@ class TransformableVideoSenderFrame : public TransformableVideoFrameInterface {
                                 TimeDelta expected_retransmission_time,
                                 uint32_t ssrc,
                                 std::vector<uint32_t> csrcs,
-                                const std::string& rid)
+                                std::string rid)
       : TransformableVideoFrameInterface(Passkey()),
         encoded_data_(encoded_image.GetEncodedData()),
         pre_transform_payload_size_(encoded_image.size()),
@@ -70,8 +70,8 @@ class TransformableVideoSenderFrame : public TransformableVideoFrameInterface {
         presentation_timestamp_(encoded_image.PresentationTimestamp()),
         expected_retransmission_time_(expected_retransmission_time),
         ssrc_(ssrc),
-        csrcs_(csrcs),
-        rid_(rid) {
+        csrcs_(std::move(csrcs)),
+        rid_(std::move(rid)) {
     RTC_DCHECK_GE(payload_type_, 0);
     RTC_DCHECK_LE(payload_type_, 127);
   }
@@ -98,6 +98,8 @@ class TransformableVideoSenderFrame : public TransformableVideoFrameInterface {
     return frame_type_ == VideoFrameType::kVideoFrameKey;
   }
 
+  std::optional<std::string> Rid() const override { return rid_; }
+
   VideoFrameMetadata Metadata() const override {
     VideoFrameMetadata metadata = header_.GetAsMetadata();
     metadata.SetSsrc(ssrc_);
@@ -144,8 +146,6 @@ class TransformableVideoSenderFrame : public TransformableVideoFrameInterface {
     return std::nullopt;
   }
 
-  const std::string& GetRid() const override { return rid_; }
-
  private:
   scoped_refptr<EncodedImageBufferInterface> encoded_data_;
   const size_t pre_transform_payload_size_;
@@ -167,12 +167,12 @@ RTPSenderVideoFrameTransformerDelegate::RTPSenderVideoFrameTransformerDelegate(
     RTPVideoFrameSenderInterface* sender,
     scoped_refptr<FrameTransformerInterface> frame_transformer,
     uint32_t ssrc,
-    const std::string& rid,
+    std::string rid,
     TaskQueueFactory* task_queue_factory)
     : sender_(sender),
       frame_transformer_(std::move(frame_transformer)),
       ssrc_(ssrc),
-      rid_(rid),
+      rid_(std::move(rid)),
       transformation_queue_(task_queue_factory->CreateTaskQueue(
           "video_frame_transformer",
           TaskQueueFactory::Priority::NORMAL)) {}
@@ -313,7 +313,8 @@ std::unique_ptr<TransformableVideoFrameInterface> CloneSenderVideoFrame(
   return std::make_unique<TransformableVideoSenderFrame>(
       encoded_image, new_header, original->GetPayloadType(), new_header.codec,
       original->GetTimestamp(), kDefaultRetransmissionsTime,
-      original->GetSsrc(), metadata.GetCsrcs(), original->GetRid());
+      original->GetSsrc(), metadata.GetCsrcs(),
+      original->Rid().value_or(std::string()));
 }
 
 }  // namespace webrtc
diff --git a/modules/rtp_rtcp/source/rtp_sender_video_frame_transformer_delegate.h b/modules/rtp_rtcp/source/rtp_sender_video_frame_transformer_delegate.h
index 9c20a6ce78..7b7a1359ea 100644
--- a/modules/rtp_rtcp/source/rtp_sender_video_frame_transformer_delegate.h
+++ b/modules/rtp_rtcp/source/rtp_sender_video_frame_transformer_delegate.h
@@ -15,6 +15,7 @@
 #include <cstdint>
 #include <memory>
 #include <optional>
+#include <string>
 #include <vector>
 
 #include "api/array_view.h"
@@ -67,7 +68,7 @@ class RTPSenderVideoFrameTransformerDelegate : public TransformedFrameCallback {
       RTPVideoFrameSenderInterface* sender,
       scoped_refptr<FrameTransformerInterface> frame_transformer,
       uint32_t ssrc,
-      const std::string& rid,
+      std::string rid,
       TaskQueueFactory* send_transport_queue);
 
   void Init();
diff --git a/modules/rtp_rtcp/source/rtp_sender_video_frame_transformer_delegate_unittest.cc b/modules/rtp_rtcp/source/rtp_sender_video_frame_transformer_delegate_unittest.cc
index 48c6d09304..a758ac14d7 100644
--- a/modules/rtp_rtcp/source/rtp_sender_video_frame_transformer_delegate_unittest.cc
+++ b/modules/rtp_rtcp/source/rtp_sender_video_frame_transformer_delegate_unittest.cc
@@ -14,6 +14,7 @@
 #include <cstdint>
 #include <memory>
 #include <optional>
+#include <string>
 #include <utility>
 #include <vector>
 
@@ -116,7 +117,8 @@ TEST_F(RtpSenderVideoFrameTransformerDelegateTest,
        RegisterTransformedFrameCallbackSinkOnInit) {
   auto delegate = make_ref_counted<RTPSenderVideoFrameTransformerDelegate>(
       &test_sender_, frame_transformer_,
-      /*ssrc=*/1111, time_controller_.CreateTaskQueueFactory().get());
+      /*ssrc=*/1111, /*rid=*/"rid",
+      time_controller_.CreateTaskQueueFactory().get());
   EXPECT_CALL(*frame_transformer_,
               RegisterTransformedFrameSinkCallback(_, 1111));
   delegate->Init();
@@ -126,7 +128,8 @@ TEST_F(RtpSenderVideoFrameTransformerDelegateTest,
        UnregisterTransformedFrameSinkCallbackOnReset) {
   auto delegate = make_ref_counted<RTPSenderVideoFrameTransformerDelegate>(
       &test_sender_, frame_transformer_,
-      /*ssrc=*/1111, time_controller_.CreateTaskQueueFactory().get());
+      /*ssrc=*/1111, /*rid=*/"rid",
+      time_controller_.CreateTaskQueueFactory().get());
   EXPECT_CALL(*frame_transformer_,
               UnregisterTransformedFrameSinkCallback(1111));
   delegate->Reset();
@@ -136,12 +139,16 @@ TEST_F(RtpSenderVideoFrameTransformerDelegateTest,
        TransformFrameCallsTransform) {
   auto delegate = make_ref_counted<RTPSenderVideoFrameTransformerDelegate>(
       &test_sender_, frame_transformer_,
-      /*ssrc=*/1111, time_controller_.CreateTaskQueueFactory().get());
+      /*ssrc=*/1111, /*rid=*/"myrid",
+      time_controller_.CreateTaskQueueFactory().get());
   VideoFrameMetadata metadata;
+  std::optional<std::string> rid;
   EXPECT_CALL(*frame_transformer_, Transform)
       .WillOnce([&](std::unique_ptr<TransformableFrameInterface> frame) {
-        metadata = static_cast<TransformableVideoFrameInterface*>(frame.get())
-                       ->Metadata();
+        TransformableVideoFrameInterface* video_frame =
+            static_cast<TransformableVideoFrameInterface*>(frame.get());
+        metadata = video_frame->Metadata();
+        rid = video_frame->Rid();
       });
 
   std::vector<uint32_t> csrcs = {1, 2, 3};
@@ -153,13 +160,15 @@ TEST_F(RtpSenderVideoFrameTransformerDelegateTest,
 
   EXPECT_EQ(metadata.GetSsrc(), 1111U);
   EXPECT_THAT(metadata.GetCsrcs(), ElementsAreArray(csrcs));
+  EXPECT_EQ(rid, "myrid");
 }
 
 TEST_F(RtpSenderVideoFrameTransformerDelegateTest,
        OnTransformedFrameCallsSenderSendVideo) {
   auto delegate = make_ref_counted<RTPSenderVideoFrameTransformerDelegate>(
       &test_sender_, frame_transformer_,
-      /*ssrc=*/1111, time_controller_.CreateTaskQueueFactory().get());
+      /*ssrc=*/1111, /*rid=*/"rid",
+      time_controller_.CreateTaskQueueFactory().get());
 
   scoped_refptr<TransformedFrameCallback> callback;
   EXPECT_CALL(*frame_transformer_, RegisterTransformedFrameSinkCallback)
@@ -186,7 +195,8 @@ TEST_F(RtpSenderVideoFrameTransformerDelegateTest,
 TEST_F(RtpSenderVideoFrameTransformerDelegateTest, CloneSenderVideoFrame) {
   auto delegate = make_ref_counted<RTPSenderVideoFrameTransformerDelegate>(
       &test_sender_, frame_transformer_,
-      /*ssrc=*/1111, time_controller_.CreateTaskQueueFactory().get());
+      /*ssrc=*/1111, /*rid=*/"rid",
+      time_controller_.CreateTaskQueueFactory().get());
 
   std::unique_ptr<TransformableFrameInterface> frame =
       GetTransformableFrame(delegate);
@@ -202,12 +212,14 @@ TEST_F(RtpSenderVideoFrameTransformerDelegateTest, CloneSenderVideoFrame) {
   EXPECT_EQ(clone->GetSsrc(), video_frame.GetSsrc());
   EXPECT_EQ(clone->GetTimestamp(), video_frame.GetTimestamp());
   EXPECT_EQ(clone->Metadata(), video_frame.Metadata());
+  EXPECT_EQ(clone->Rid(), video_frame.Rid());
 }
 
 TEST_F(RtpSenderVideoFrameTransformerDelegateTest, CloneKeyFrame) {
   auto delegate = make_ref_counted<RTPSenderVideoFrameTransformerDelegate>(
       &test_sender_, frame_transformer_,
-      /*ssrc=*/1111, time_controller_.CreateTaskQueueFactory().get());
+      /*ssrc=*/1111, /*rid=*/"rid",
+      time_controller_.CreateTaskQueueFactory().get());
 
   std::unique_ptr<TransformableFrameInterface> frame =
       GetTransformableFrame(delegate, /*key_frame=*/true);
@@ -223,12 +235,14 @@ TEST_F(RtpSenderVideoFrameTransformerDelegateTest, CloneKeyFrame) {
   EXPECT_EQ(clone->GetSsrc(), video_frame.GetSsrc());
   EXPECT_EQ(clone->GetTimestamp(), video_frame.GetTimestamp());
   EXPECT_EQ(clone->Metadata(), video_frame.Metadata());
+  EXPECT_EQ(clone->Rid(), video_frame.Rid());
 }
 
 TEST_F(RtpSenderVideoFrameTransformerDelegateTest, MetadataAfterSetMetadata) {
   auto delegate = make_ref_counted<RTPSenderVideoFrameTransformerDelegate>(
       &test_sender_, frame_transformer_,
-      /*ssrc=*/1111, time_controller_.CreateTaskQueueFactory().get());
+      /*ssrc=*/1111, /*rid=*/"rid",
+      time_controller_.CreateTaskQueueFactory().get());
 
   std::unique_ptr<TransformableFrameInterface> frame =
       GetTransformableFrame(delegate);
@@ -256,7 +270,8 @@ TEST_F(RtpSenderVideoFrameTransformerDelegateTest,
        ReceiverFrameConvertedToSenderFrame) {
   auto delegate = make_ref_counted<RTPSenderVideoFrameTransformerDelegate>(
       &test_sender_, frame_transformer_,
-      /*ssrc=*/1111, time_controller_.CreateTaskQueueFactory().get());
+      /*ssrc=*/1111, /*rid=*/"rid",
+      time_controller_.CreateTaskQueueFactory().get());
 
   const uint8_t payload_type = 1;
   const uint32_t timestamp = 2;
@@ -304,7 +319,8 @@ TEST_F(RtpSenderVideoFrameTransformerDelegateTest,
 TEST_F(RtpSenderVideoFrameTransformerDelegateTest, SettingRTPTimestamp) {
   auto delegate = make_ref_counted<RTPSenderVideoFrameTransformerDelegate>(
       &test_sender_, frame_transformer_,
-      /*ssrc=*/1111, time_controller_.CreateTaskQueueFactory().get());
+      /*ssrc=*/1111, /*rid=*/"rid",
+      time_controller_.CreateTaskQueueFactory().get());
 
   std::unique_ptr<TransformableFrameInterface> frame =
       GetTransformableFrame(delegate);
@@ -322,7 +338,8 @@ TEST_F(RtpSenderVideoFrameTransformerDelegateTest,
        ShortCircuitingSkipsTransform) {
   auto delegate = make_ref_counted<RTPSenderVideoFrameTransformerDelegate>(
       &test_sender_, frame_transformer_,
-      /*ssrc=*/1111, time_controller_.CreateTaskQueueFactory().get());
+      /*ssrc=*/1111, /*rid=*/"rid",
+      time_controller_.CreateTaskQueueFactory().get());
   EXPECT_CALL(*frame_transformer_,
               RegisterTransformedFrameSinkCallback(_, 1111));
   delegate->Init();
diff --git a/modules/rtp_rtcp/source/rtp_sender_video_unittest.cc b/modules/rtp_rtcp/source/rtp_sender_video_unittest.cc
index b63bafe34e..ea8f563a35 100644
--- a/modules/rtp_rtcp/source/rtp_sender_video_unittest.cc
+++ b/modules/rtp_rtcp/source/rtp_sender_video_unittest.cc
@@ -1575,7 +1575,8 @@ class RtpSenderVideoWithFrameTransformerTest : public ::testing::Test {
             env_,
             {.outgoing_transport = &transport_,
              .retransmission_rate_limiter = &retransmission_rate_limiter_,
-             .local_media_ssrc = kSsrc}) {
+             .local_media_ssrc = kSsrc,
+             .rid = "myrid"}) {
     rtp_module_.SetSequenceNumber(kSeqNum);
     rtp_module_.SetStartTimestamp(0);
   }
@@ -1818,6 +1819,7 @@ TEST_F(RtpSenderVideoWithFrameTransformerTest,
                     transformable_frame.release()));
             ASSERT_TRUE(frame);
             auto metadata = frame->Metadata();
+            EXPECT_EQ(frame->Rid(), "myrid");
             EXPECT_EQ(metadata.GetWidth(), 1280u);
             EXPECT_EQ(metadata.GetHeight(), 720u);
             EXPECT_EQ(metadata.GetFrameId(), 10);
diff --git a/modules/rtp_rtcp/source/rtp_video_stream_receiver_frame_transformer_delegate.cc b/modules/rtp_rtcp/source/rtp_video_stream_receiver_frame_transformer_delegate.cc
index 59c2e9a875..b3a77c197f 100644
--- a/modules/rtp_rtcp/source/rtp_video_stream_receiver_frame_transformer_delegate.cc
+++ b/modules/rtp_rtcp/source/rtp_video_stream_receiver_frame_transformer_delegate.cc
@@ -75,11 +75,6 @@ class TransformableVideoReceiverFrame
     return frame_->FrameType() == VideoFrameType::kVideoFrameKey;
   }
 
-  const std::string& GetRid() const override {
-    static const std::string empty;
-    return empty;
-  }
-
   VideoFrameMetadata Metadata() const override { return metadata_; }
 
   void SetMetadata(const VideoFrameMetadata& metadata) override {
diff --git a/modules/rtp_rtcp/source/rtp_video_stream_receiver_frame_transformer_delegate_unittest.cc b/modules/rtp_rtcp/source/rtp_video_stream_receiver_frame_transformer_delegate_unittest.cc
index ea96a5201d..2e4c1b6e08 100644
--- a/modules/rtp_rtcp/source/rtp_video_stream_receiver_frame_transformer_delegate_unittest.cc
+++ b/modules/rtp_rtcp/source/rtp_video_stream_receiver_frame_transformer_delegate_unittest.cc
@@ -217,6 +217,7 @@ TEST(RtpVideoStreamReceiverFrameTransformerDelegateTest,
         EXPECT_GE(frame->ReceiveTime()->us(), 0);
         EXPECT_EQ(frame->CaptureTime(), capture_time);
         EXPECT_EQ(frame->SenderCaptureTimeOffset(), sender_capture_time_offset);
+        EXPECT_FALSE(frame->Rid().has_value());
       });
   // The delegate creates a transformable frame from the RtpFrameObject.
   delegate->TransformFrame(CreateRtpFrameObject(video_header, csrcs));
