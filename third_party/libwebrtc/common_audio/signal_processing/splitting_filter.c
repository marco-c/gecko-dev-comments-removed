














#include "common_audio/signal_processing/include/signal_processing_library.h"
#include "rtc_base/checks.h"


enum {
  kMaxBandFrameLength = 320  
};


static const float WebRtcSpl_kAllPassFilter1[3] = {0.0979309082f, 0.5643005371f,
                                                   0.8737335205f};
static const float WebRtcSpl_kAllPassFilter2[3] = {
    0.32551574707f, 0.74862670898f, 0.96145629882f};



















static void WebRtcSpl_AllPassQMF(float* in_data,
                                 size_t data_length,
                                 float* out_data,
                                 const float* filter_coefficients,
                                 float* filter_state) {
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  size_t k;
  float diff;
  

  
  
  

  
  
  
  diff = in_data[0] - filter_state[1];
  
  out_data[0] = filter_state[0] + filter_coefficients[0] * diff;

  
  for (k = 1; k < data_length; k++) {
    
    diff = in_data[k] - out_data[k - 1];
    
    out_data[k] = in_data[k - 1] + filter_coefficients[0] * diff;
  }

  
  filter_state[0] =
      in_data[data_length - 1];  
  filter_state[1] =
      out_data[data_length - 1];  

  
  
  diff = out_data[0] - filter_state[3];
  
  in_data[0] = filter_state[2] + filter_coefficients[1] * diff;
  for (k = 1; k < data_length; k++) {
    
    diff = out_data[k] - in_data[k - 1];
    
    in_data[k] = out_data[k - 1] + filter_coefficients[1] * diff;
  }

  filter_state[2] =
      out_data[data_length - 1];  
  filter_state[3] =
      in_data[data_length - 1];  

  
  
  diff = in_data[0] - filter_state[5];
  
  out_data[0] = filter_state[4] + filter_coefficients[2] * diff;
  for (k = 1; k < data_length; k++) {
    
    diff = in_data[k] - out_data[k - 1];
    
    out_data[k] = in_data[k - 1] + filter_coefficients[2] * diff;
  }
  filter_state[4] =
      in_data[data_length - 1];  
  filter_state[5] =
      out_data[data_length - 1];  
}

void WebRtcSpl_AnalysisQMF(const float* in_data,
                           size_t in_data_length,
                           float* low_band,
                           float* high_band,
                           float* filter_state1,
                           float* filter_state2) {
  size_t i;
  int16_t k;
  float half_in1[kMaxBandFrameLength];
  float half_in2[kMaxBandFrameLength];
  float filter1[kMaxBandFrameLength];
  float filter2[kMaxBandFrameLength];
  const size_t band_length = in_data_length / 2;
  RTC_DCHECK_EQ(0, in_data_length % 2);
  RTC_DCHECK_LE(band_length, kMaxBandFrameLength);

  
  for (i = 0, k = 0; i < band_length; i++, k += 2) {
    half_in2[i] = in_data[k];
    half_in1[i] = in_data[k + 1];
  }

  
  WebRtcSpl_AllPassQMF(half_in1, band_length, filter1,
                       WebRtcSpl_kAllPassFilter1, filter_state1);
  WebRtcSpl_AllPassQMF(half_in2, band_length, filter2,
                       WebRtcSpl_kAllPassFilter2, filter_state2);

  
  
  for (i = 0; i < band_length; i++) {
    low_band[i] = (filter1[i] + filter2[i]) * 0.5f;
    high_band[i] = (filter1[i] - filter2[i]) * 0.5f;
  }
}

void WebRtcSpl_SynthesisQMF(const float* low_band,
                            const float* high_band,
                            size_t band_length,
                            float* out_data,
                            float* filter_state1,
                            float* filter_state2) {
  float half_in1[kMaxBandFrameLength];
  float half_in2[kMaxBandFrameLength];
  float filter1[kMaxBandFrameLength];
  float filter2[kMaxBandFrameLength];
  size_t i;
  int16_t k;
  RTC_DCHECK_LE(band_length, kMaxBandFrameLength);

  
  
  for (i = 0; i < band_length; i++) {
    half_in1[i] = low_band[i] + high_band[i];
    half_in2[i] = low_band[i] - high_band[i];
  }

  
  WebRtcSpl_AllPassQMF(half_in1, band_length, filter1,
                       WebRtcSpl_kAllPassFilter2, filter_state1);
  WebRtcSpl_AllPassQMF(half_in2, band_length, filter2,
                       WebRtcSpl_kAllPassFilter1, filter_state2);

  
  
  for (i = 0, k = 0; i < band_length; i++) {
    out_data[k++] = filter2[i] > -32768.0f ?
                    (filter2[i] < 32767.0f ? filter2[i] : 32767.0f) : -32768.0f;
    out_data[k++] = filter1[i] > -32768.0f ?
                    (filter1[i] < 32767.0f ? filter1[i] : 32767.0f) : -32768.0f;
  }
}
