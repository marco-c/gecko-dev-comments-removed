









#include "video/timing/simulator/decodability_tracker.h"

#include <memory>
#include <utility>

#include "absl/base/nullability.h"
#include "absl/container/inlined_vector.h"
#include "api/environment/environment.h"
#include "api/sequence_checker.h"
#include "api/video/encoded_frame.h"
#include "rtc_base/checks.h"
#include "rtc_base/logging.h"
#include "video/timing/simulator/assembler.h"

namespace webrtc::video_timing_simulator {



constexpr int kMaxFrameBufferSize = 800;
constexpr int kMaxFrameBufferHistory = 1 << 13;

DecodabilityTracker::DecodabilityTracker(const Environment& env,
                                         DecodabilityTrackerEvents* absl_nonnull
                                             observer)
    : env_(env),
      frame_buffer_(kMaxFrameBufferSize,
                    kMaxFrameBufferHistory,
                    env.field_trials()),
      observer_(*observer),
      decoded_frame_id_cb_(nullptr) {
  RTC_DCHECK_RUN_ON(&sequence_checker_);
}

DecodabilityTracker::~DecodabilityTracker() {
  RTC_DCHECK_RUN_ON(&sequence_checker_);
}

void DecodabilityTracker::SetDecodedFrameIdCallback(
    DecodedFrameIdCallback* absl_nonnull decoded_frame_id_cb) {
  RTC_DCHECK_RUN_ON(&sequence_checker_);
  decoded_frame_id_cb_ = decoded_frame_id_cb;
}

void DecodabilityTracker::OnAssembledFrame(
    std::unique_ptr<EncodedFrame> assembled_frame) {
  RTC_DCHECK_RUN_ON(&sequence_checker_);
  RTC_CHECK(decoded_frame_id_cb_) << "Callback must be set before running";
  if (!frame_buffer_.InsertFrame(std::move(assembled_frame))) {
    RTC_LOG(LS_ERROR) << "FrameBuffer insertion error";
  }
  RTC_DCHECK_EQ(frame_buffer_.GetTotalNumberOfDroppedFrames(), 0)
      << "The FrameBuffer should never drop frames when used by the "
         "DecodabilityTracker";
  
  
  
  
  
  
  
  while (frame_buffer_.DecodableTemporalUnitsInfo()) {
    absl::InlinedVector<std::unique_ptr<webrtc::EncodedFrame>, 4>
        next_decodable_frames =
            frame_buffer_.ExtractNextDecodableTemporalUnit();
    
    
    for (std::unique_ptr<EncodedFrame>& encoded_frame : next_decodable_frames) {
      observer_.OnDecodableFrame(*encoded_frame);
      decoded_frame_id_cb_->OnDecodedFrameId(encoded_frame->Id());
      encoded_frame.reset();  
    }
  }
}

}  
