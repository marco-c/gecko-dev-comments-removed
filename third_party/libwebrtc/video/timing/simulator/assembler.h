








#ifndef VIDEO_TIMING_SIMULATOR_ASSEMBLER_H_
#define VIDEO_TIMING_SIMULATOR_ASSEMBLER_H_

#include <cstdint>
#include <memory>

#include "absl/base/nullability.h"
#include "absl/container/flat_hash_set.h"
#include "api/array_view.h"
#include "api/call/transport.h"
#include "api/environment/environment.h"
#include "api/sequence_checker.h"
#include "api/video/encoded_frame.h"
#include "call/video_receive_stream.h"
#include "modules/rtp_rtcp/include/receive_statistics.h"
#include "rtc_base/thread_annotations.h"
#include "video/rtp_video_stream_receiver2.h"

namespace webrtc::video_timing_simulator {


class AssemblerEvents {
 public:
  virtual ~AssemblerEvents() = default;
  virtual void OnAssembledFrame(const EncodedFrame& assembled_frame) = 0;
};


class AssembledFrameCallback {
 public:
  virtual ~AssembledFrameCallback() = default;
  virtual void OnAssembledFrame(
      std::unique_ptr<EncodedFrame> encoded_frame) = 0;
};


class DecodedFrameIdCallback {
 public:
  virtual ~DecodedFrameIdCallback() = default;
  virtual void OnDecodedFrameId(int64_t frame_id) = 0;
};




class Assembler : public DecodedFrameIdCallback,
                  public Transport,
                  public RtpVideoStreamReceiver2::OnCompleteFrameCallback {
 public:
  Assembler(const Environment& env,
            uint32_t ssrc,
            AssemblerEvents* absl_nonnull observer,
            AssembledFrameCallback* absl_nonnull assembled_frame_cb);
  ~Assembler() override;

  Assembler(const Assembler&) = delete;
  Assembler& operator=(const Assembler&) = delete;

  
  
  
  void InsertPacket(const RtpPacketReceived& rtp_packet);

  
  
  
  void OnDecodedFrameId(int64_t frame_id) override;

  
  
  bool SendRtp(ArrayView<const uint8_t>, const PacketOptions&) override {
    return true;
  }
  bool SendRtcp(ArrayView<const uint8_t>, const PacketOptions&) override {
    return true;
  }

  
  
  void OnCompleteFrame(std::unique_ptr<EncodedFrame> encoded_frame) override;

 private:
  
  SequenceChecker sequence_checker_;
  const Environment env_;

  
  const VideoReceiveStreamInterface::Config video_receive_stream_config_
      RTC_GUARDED_BY(sequence_checker_);
  std::unique_ptr<ReceiveStatistics> rtp_receive_statistics_
      RTC_GUARDED_BY(sequence_checker_);
  absl::flat_hash_set<uint8_t> registered_payload_types_
      RTC_GUARDED_BY(sequence_checker_);
  RtpVideoStreamReceiver2 rtp_video_stream_receiver2_
      RTC_GUARDED_BY(sequence_checker_);

  
  AssemblerEvents& observer_;
  AssembledFrameCallback& assembled_frame_cb_;
};

}  

#endif  
