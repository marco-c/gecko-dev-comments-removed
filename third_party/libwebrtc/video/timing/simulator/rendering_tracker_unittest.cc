









#include "video/timing/simulator/rendering_tracker.h"

#include <cstdint>
#include <memory>
#include <utility>

#include "api/sequence_checker.h"
#include "api/units/time_delta.h"
#include "api/video/encoded_frame.h"
#include "api/video/video_frame.h"
#include "modules/video_coding/timing/timing.h"
#include "rtc_base/thread_annotations.h"
#include "test/gmock.h"
#include "test/gtest.h"
#include "video/timing/simulator/assembler.h"
#include "video/timing/simulator/test/encoded_frame_generators.h"
#include "video/timing/simulator/test/matchers.h"
#include "video/timing/simulator/test/simulated_time_test_fixture.h"

namespace webrtc::video_timing_simulator {
namespace {

using ::testing::_;
using ::testing::Eq;
using ::testing::InSequence;
using ::testing::NiceMock;

class MockRenderingTrackerEvents : public RenderingTrackerEvents {
 public:
  MOCK_METHOD(void,
              OnDecodedFrame,
              (const EncodedFrame& decoded_frame,
               int frames_dropped,
               TimeDelta jitter_buffer_minimum_delay,
               TimeDelta jitter_buffer_target_delay,
               TimeDelta jitter_buffer_delay),
              (override));
  MOCK_METHOD(void,
              OnRenderedFrame,
              (const VideoFrame& rendered_frame),
              (override));
};

class MockDecodedFrameIdCallback : public DecodedFrameIdCallback {
 public:
  MOCK_METHOD(void, OnDecodedFrameId, (int64_t frame_id), (override));
};

class RenderingTrackerTest : public SimulatedTimeTestFixture {
 protected:
  RenderingTrackerTest() : done_(false) {
    SendTask([this]() {
      RTC_DCHECK_RUN_ON(queue_ptr_);
      rendering_tracker_ = std::make_unique<RenderingTracker>(
          env_,
          RenderingTracker::Config{
              .ssrc = EncodedFrameBuilderGenerator::kSsrc,
              .max_wait_for_keyframe = TimeDelta::Millis(200),
              .max_wait_for_frame = TimeDelta::Millis(3000),
              .render_delay = TimeDelta::Millis(10)},
          std::make_unique<VCMTiming>(&env_.clock(), env_.field_trials()),
          &rendering_tracker_events_);
      rendering_tracker_->SetDecodedFrameIdCallback(&decoded_frame_id_cb_);
    });
  }
  ~RenderingTrackerTest() {
    SendTask([this]() {
      RTC_DCHECK_RUN_ON(queue_ptr_);
      rendering_tracker_.reset();
    });
  }

  void OnAssembledFrame(std::unique_ptr<EncodedFrame> assembled_frame) {
    SendTask([this, assembled_frame = std::move(assembled_frame)]() mutable {
      RTC_DCHECK_RUN_ON(queue_ptr_);
      rendering_tracker_->OnAssembledFrame(std::move(assembled_frame));
    });
  }

  
  NiceMock<MockRenderingTrackerEvents> rendering_tracker_events_;
  NiceMock<MockDecodedFrameIdCallback> decoded_frame_id_cb_;

  
  std::unique_ptr<RenderingTracker> rendering_tracker_
      RTC_PT_GUARDED_BY(queue_ptr_);

  
  bool done_;
};



TEST_F(RenderingTrackerTest, KeyframeIsRenderedImmediately) {
  SingleLayerEncodedFrameGenerator generator(env_);

  auto keyframe = generator.NextEncodedFrame();
  EXPECT_THAT(keyframe->num_references, Eq(0));
  EXPECT_CALL(decoded_frame_id_cb_, OnDecodedFrameId(0));
  EXPECT_CALL(rendering_tracker_events_, OnRenderedFrame(VideoFrameWithId(0)));
  OnAssembledFrame(std::move(keyframe));
  
}

TEST_F(RenderingTrackerTest, DeltaFrameIsNeverRendered) {
  SingleLayerEncodedFrameGenerator generator(env_);

  auto keyframe = generator.NextEncodedFrame();

  time_controller_.AdvanceTime(TimeDelta::Millis(33));  
  auto delta_frame = generator.NextEncodedFrame();
  EXPECT_THAT(delta_frame->num_references, Eq(1));
  EXPECT_CALL(decoded_frame_id_cb_, OnDecodedFrameId(_)).Times(0);
  EXPECT_CALL(rendering_tracker_events_, OnRenderedFrame(_)).Times(0);
  OnAssembledFrame(std::move(delta_frame));

  time_controller_.AdvanceTime(TimeDelta::Seconds(1));
}

TEST_F(RenderingTrackerTest, KeyframeAndDeltaFrameAreRendered) {
  SingleLayerEncodedFrameGenerator generator(env_);

  {
    InSequence seq;
    auto keyframe = generator.NextEncodedFrame();
    EXPECT_CALL(decoded_frame_id_cb_, OnDecodedFrameId(0));
    EXPECT_CALL(rendering_tracker_events_,
                OnRenderedFrame(VideoFrameWithId(0)));
    OnAssembledFrame(std::move(keyframe));

    time_controller_.AdvanceTime(TimeDelta::Millis(33));  
    auto delta_frame = generator.NextEncodedFrame();
    EXPECT_CALL(decoded_frame_id_cb_, OnDecodedFrameId(1));
    EXPECT_CALL(rendering_tracker_events_, OnRenderedFrame(VideoFrameWithId(1)))
        .WillOnce([this] { done_ = true; });
    OnAssembledFrame(std::move(delta_frame));

    time_controller_.Wait([this] { return done_; });
  }
}

TEST_F(RenderingTrackerTest, ReorderedKeyframeAndDeltaFrameAreRendered) {
  SingleLayerEncodedFrameGenerator generator(env_);

  {
    InSequence seq;
    auto keyframe = generator.NextEncodedFrame();

    time_controller_.AdvanceTime(TimeDelta::Millis(33));  
    auto delta_frame = generator.NextEncodedFrame();
    OnAssembledFrame(std::move(delta_frame));
    EXPECT_CALL(rendering_tracker_events_,
                OnRenderedFrame(VideoFrameWithId(0)));
    EXPECT_CALL(rendering_tracker_events_, OnRenderedFrame(VideoFrameWithId(1)))
        .WillOnce([this] { done_ = true; });
    OnAssembledFrame(std::move(keyframe));

    time_controller_.Wait([this] { return done_; });
  }
}

TEST_F(RenderingTrackerTest, TwoTemporalLayerGoPsAreRendered) {
  TemporalLayersEncodedFrameGenerator generator(env_);
  {
    InSequence seq;
    for (int i = 0; i < 7; ++i) {
      EXPECT_CALL(rendering_tracker_events_,
                  OnRenderedFrame(VideoFrameWithId(i)));
      OnAssembledFrame(generator.NextEncodedFrame());
      time_controller_.AdvanceTime(TimeDelta::Millis(33));  
    }
    EXPECT_CALL(rendering_tracker_events_, OnRenderedFrame(VideoFrameWithId(7)))
        .WillOnce([this] { done_ = true; });
    OnAssembledFrame(generator.NextEncodedFrame());

    time_controller_.Wait([this] { return done_; });
  }
}

TEST_F(RenderingTrackerTest, DroppedFrameIsReported) {
  TemporalLayersEncodedFrameGenerator generator(env_);

  {
    InSequence seq;

    auto keyframe = generator.NextEncodedFrame();
    EXPECT_CALL(
        rendering_tracker_events_,
        OnDecodedFrame(EncodedFrameWithId(0), 0, _, _, _));
    OnAssembledFrame(std::move(keyframe));

    
    time_controller_.AdvanceTime(TimeDelta::Millis(66));  
    auto tl2a = generator.NextEncodedFrame();
    auto tl1 = generator.NextEncodedFrame();
    EXPECT_CALL(
        rendering_tracker_events_,
        OnDecodedFrame(EncodedFrameWithId(2), 1, _, _, _));
    OnAssembledFrame(std::move(tl1));

    
    
    EXPECT_CALL(rendering_tracker_events_,
                OnDecodedFrame(EncodedFrameWithId(1), _, _, _, _))
        .Times(0);
    OnAssembledFrame(std::move(tl2a));

    
    EXPECT_CALL(
        rendering_tracker_events_,
        OnDecodedFrame(EncodedFrameWithId(3), 0, _, _, _))
        .WillOnce([this] { done_ = true; });
    time_controller_.AdvanceTime(TimeDelta::Millis(33));  
    auto tl2b = generator.NextEncodedFrame();
    OnAssembledFrame(std::move(tl2b));

    time_controller_.Wait([this] { return done_; });
  }
}

TEST_F(RenderingTrackerTest, JitterBufferStatsAreReported) {
  SingleLayerEncodedFrameGenerator generator(env_);

  
  for (int i = 0; i < 30 * 10; ++i) {
    auto frame = generator.NextEncodedFrame();
    OnAssembledFrame(std::move(frame));
    time_controller_.AdvanceTime(TimeDelta::Millis(33));  
  }

  
  auto on_time_frame = generator.NextEncodedFrame();
  EXPECT_CALL(
      rendering_tracker_events_,
      OnDecodedFrame(EncodedFrameWithId(300), _,
                     TimeDelta::Millis(11), _,
                     TimeDelta::Millis(11)));
  OnAssembledFrame(std::move(on_time_frame));

  
  
  time_controller_.AdvanceTime(TimeDelta::Millis(43));  
  auto late_frame = generator.NextEncodedFrame();
  EXPECT_CALL(
      rendering_tracker_events_,
      OnDecodedFrame(EncodedFrameWithId(301), _,
                     TimeDelta::Millis(11), _,
                     TimeDelta::Millis(1)))
      .WillOnce([this] { done_ = true; });
  OnAssembledFrame(std::move(late_frame));

  time_controller_.Wait([this] { return done_; });
}

}  
}  
