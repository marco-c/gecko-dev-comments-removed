








#ifndef MODULES_CONGESTION_CONTROLLER_SCREAM_DELAY_BASED_CONGESTION_CONTROL_H_
#define MODULES_CONGESTION_CONTROLLER_SCREAM_DELAY_BASED_CONGESTION_CONTROL_H_

#include <algorithm>

#include "api/transport/network_types.h"
#include "api/units/data_rate.h"
#include "api/units/data_size.h"
#include "api/units/time_delta.h"
#include "api/units/timestamp.h"
#include "modules/congestion_controller/scream/scream_v2_parameters.h"
#include "rtc_base/numerics/windowed_min_filter.h"

namespace webrtc {






class DelayBasedCongestionControl {
 public:
  explicit DelayBasedCongestionControl(ScreamV2Parameters params);

  void OnTransportPacketsFeedback(const TransportPacketsFeedback& msg);

  
  
  void SetMinDelayBasedBwe(DataRate min_delay_based_bwe) {
    min_delay_based_bwe_ = min_delay_based_bwe;
  }

  
  
  
  bool IsQueueDelayDetected() const;

  
  
  bool ShouldReduceReferenceWindow() const;

  DataSize UpdateReferenceWindow(DataSize rew_window,
                                 double virtual_alpha_lim) const;

  double scale_increase() const {
    return std::clamp(1 - queue_delay_avg_ / (params_.queue_delay_target.Get() *
                                              params_.queue_delay_threshold),
                      0.1, 1.0);
  }

  
  TimeDelta queue_delay() const { return queue_delay_avg_; }

 private:
  void UpdateQueueDelayAverage(TimeDelta one_way_delay);

  const ScreamV2Parameters params_;

  DataRate min_delay_based_bwe_;

  
  
  Timestamp last_base_delay_update_ = Timestamp::MinusInfinity();
  TimeDelta next_base_delay_ = TimeDelta::PlusInfinity();
  WindowedMinFilter<TimeDelta> base_delay_history_;

  TimeDelta last_smoothed_rtt_ = TimeDelta::Zero();
  Timestamp last_update_qdelay_avg_time_ = Timestamp::MinusInfinity();
  TimeDelta queue_delay_avg_ = TimeDelta::PlusInfinity();
};

}  
#endif  
