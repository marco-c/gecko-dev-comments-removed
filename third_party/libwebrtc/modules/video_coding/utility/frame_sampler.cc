









#include "modules/video_coding/utility/frame_sampler.h"

#include <cstdint>

#include "api/units/time_delta.h"
#include "api/video/video_frame.h"
#include "modules/include/module_common_types_public.h"

namespace webrtc {

FrameSampler::FrameSampler(TimeDelta interval) : sampling_interval_(interval) {}

bool FrameSampler::ShouldBeSampled(const VideoFrame& frame) {
  
  const int64_t interval_rtp = sampling_interval_.ms() * 90;
  if (!last_rtp_timestamp_sampled_) {
    
    
    last_rtp_timestamp_ = frame.rtp_timestamp() + interval_rtp / 30;
    last_rtp_timestamp_sampled_ = frame.rtp_timestamp();
    return true;
  }
  
  
  
  
  uint32_t extrapolated_rtp_timestamp =
      frame.rtp_timestamp() + (frame.rtp_timestamp() - *last_rtp_timestamp_);
  last_rtp_timestamp_ = frame.rtp_timestamp();

  if (IsNewerTimestamp(extrapolated_rtp_timestamp,
                       *last_rtp_timestamp_sampled_ + interval_rtp)) {
    last_rtp_timestamp_sampled_ = frame.rtp_timestamp();
    return true;
  }
  return false;
}

}  
