



use std::fs;

use anyhow::{bail, Context};
use camino::Utf8PathBuf;

use crate::Result;





#[derive(Default)]
pub struct BindgenPaths {
    layers: Vec<Box<dyn BindgenPathsLayer>>,
}

impl BindgenPaths {
    #[cfg(feature = "cargo-metadata")]
    
    
    
    pub fn add_cargo_metadata_layer(&mut self, no_deps: bool) -> Result<()> {
        self.add_layer(
            crate::cargo_metadata::CrateConfigSupplier::from_cargo_metadata_command(no_deps)?,
        );
        Ok(())
    }

    
    
    
    pub fn add_config_override_layer(&mut self, path: Utf8PathBuf) {
        self.add_layer(ConfigOverrideLayer { path })
    }

    
    
    
    pub fn add_layer(&mut self, layer: impl BindgenPathsLayer + 'static) {
        self.layers.push(Box::new(layer));
    }

    
    pub fn get_config(&self, crate_name: &str) -> Result<toml::value::Table> {
        for layer in &self.layers {
            if let Some(table) = layer.get_config(crate_name)? {
                return Ok(table);
            }
        }
        Ok(toml::value::Table::default())
    }

    
    pub fn get_udl_path(&self, crate_name: &str, udl_name: &str) -> Option<Utf8PathBuf> {
        self.layers
            .iter()
            .find_map(|l| l.get_udl_path(crate_name, udl_name))
    }

    
    pub fn get_udl(&self, crate_name: &str, udl_name: &str) -> Result<String> {
        match self.get_udl_path(crate_name, udl_name) {
            Some(path) => Ok(fs::read_to_string(path)?),
            None => bail!("UDL file {udl_name:?} not found for crate {crate_name:?}"),
        }
    }
}


pub trait BindgenPathsLayer {
    
    
    
    
    
    
    
    
    fn get_config(&self, _crate_name: &str) -> Result<Option<toml::value::Table>> {
        Ok(None)
    }

    
    
    
    fn get_udl_path(&self, _crate_name: &str, _udl_name: &str) -> Option<Utf8PathBuf> {
        None
    }
}

struct ConfigOverrideLayer {
    path: Utf8PathBuf,
}

impl BindgenPathsLayer for ConfigOverrideLayer {
    fn get_config(&self, _crate_name: &str) -> Result<Option<toml::value::Table>> {
        
        
        let contents = fs::read_to_string(&self.path)
            .with_context(|| format!("read file: {:?}", self.path))?;
        let toml = toml::de::from_str(&contents)
            .with_context(|| format!("parse toml: {:?}", self.path))?;
        Ok(Some(toml))
    }
}
