





import os

from mach.decorators import Command, CommandArgument


def classname_for_test(test, test_path):
    """Convert path of test file to gradle recognized test suite name"""
    
    
    
    
    return (
        os.path.normpath(test)
        .split(os.path.normpath(test_path))[-1]
        .removeprefix(os.path.sep)
        .replace(os.path.sep, ".")
        .removesuffix(".kt")
        .removesuffix(".java")
    )


def project_for_test(test, prefix):
    """Get android project that test belongs to"""
    
    
    
    
    return (
        os.path.normpath(test)
        .split(os.path.normpath(prefix))[-1]
        .removeprefix(os.path.sep)
        .split(os.path.sep)[0]
    )


def project_for_ac(test, prefix, test_path):
    """Get project name for android-component subprojects from path of test file"""
    
    
    
    
    
    return (
        os.path.normpath(test)
        .split(os.path.normpath(prefix))[-1]
        .split(os.path.normpath(test_path))[0]
        .removeprefix(os.path.sep)
        .removesuffix(os.path.sep)
        .replace(os.path.sep, "-")
    )


@Command(
    "android-test",
    category="testing",
    description="Run Android tests.",
)
@CommandArgument(
    "--subproject",
    default="fenix",
    choices=["fenix", "focus", "android-components", "ac", "geckoview", "gv"],
    help="Android subproject to run tests for.",
)
@CommandArgument(
    "--gradle-variant",
    default=None,
    help="The gradle project variant to use (eg. Debug, FocusNightly).",
)
@CommandArgument(
    "--test",
    default=None,
    help="File path of test to run.",
)
def run_android_test(
    command_context,
    subproject,
    gradle_variant=None,
    test=None,
    test_objects=[],
    **kwargs,
):
    
    tests = [test["name"] for test in test_objects]
    if test:
        tests.append(test.strip())

    
    if test:
        prefix = os.path.join("mobile", "android")
        subproject = project_for_test(test, prefix)

    
    ALIASES = {
        "focus": "focus-android",
        "ac": "android-components",
        "gv": "geckoview",
    }
    subproject = ALIASES.get(subproject, subproject)

    
    if not gradle_variant:
        gradle_variant = "FocusDebug" if (subproject == "focus-android") else "Debug"

    
    gradle_command = ["-q"]

    
    if subproject == "fenix":
        subdir = os.path.join("mobile", "android", "fenix", "app")
    elif subproject == "focus-android":
        subdir = os.path.join("mobile", "android", "focus-android", "app")
    elif subproject == "android-components":
        subdir = os.path.join("mobile", "android", "android-components")
    elif subproject == "geckoview":
        subdir = os.path.join("mobile", "android", "geckoview")
    else:
        return None
    gradle_command.append("-p")
    gradle_command.append(subdir)

    
    test_path = os.path.join("src", "test", "java")

    
    gradle_unittest = f"test{gradle_variant}UnitTest"
    if tests and (subproject == "android-components"):
        
        def project_name(test):
            prefix = os.path.join(subdir, "components")
            return project_for_ac(test, prefix, test_path)

        for p in dict.fromkeys(project_name(t) for t in tests):
            gradle_command.append(f":components:{p}:{gradle_unittest}")
    else:
        gradle_command.append(gradle_unittest)

    
    gradle_command.append("--rerun")
    for t in tests:
        gradle_command.append("--tests")
        gradle_command.append(classname_for_test(t, test_path))

    return command_context._mach_context.commands.dispatch(
        "gradle", command_context._mach_context, args=gradle_command
    )
