






class SoftNavigationTestHelper {
  




  constructor(test) {
    this.test_ = test;
  }

  







  async withTimeoutMessage(promise, message, timeout = 1000) {
    return Promise.race([
      promise,
      new Promise((resolve, reject) => {
        this.test_.step_timeout(() => {
          reject(new Error(message));
        }, timeout);
      }),
    ]);
  }

  










  async newPromiseWithTimeoutMessage(executor, message, timeout = 1000) {
    return this.withTimeoutMessage(new Promise(executor), message, timeout);
  }

  









  async getBufferedPerformanceEntriesWithTimeout(
      type, minNumEntries = 1, timeout = 1000) {
    let observer;
    return this
        .newPromiseWithTimeoutMessage(
            (resolve) => {
              const entries = [];
              observer = new PerformanceObserver((list) => {
                entries.push(...list.getEntries());
                if (entries.length >= minNumEntries) {
                  resolve(entries);
                }
              })
              observer.observe({
                type: type,
                buffered: true,
              });
            },
            `${minNumEntries} entries of type ${type} never arrived`,
            timeout)
        .finally(() => {
          observer.disconnect();
        });
  }

  







  static getPerformanceEntries(type, minNumEntries = 1) {
    return new Promise((resolve) => {
      const entries = [];
      const observer = new PerformanceObserver((list) => {
        entries.push(...list.getEntries());
        if (entries.length >= minNumEntries) {
          resolve(entries);
          observer.disconnect();
        }
      })
      observer.observe({
        type: type,
      });
    });
  }

  











  async clickAndExpectSoftNavigation(clickTarget, url, modifyDOM) {
    let targetId;
    clickTarget.addEventListener('click', async () => {
      history.pushState({}, '', url);
      targetId = await modifyDOM();
    }, {once: true});

    
    const softNavPromise =
        SoftNavigationTestHelper.getPerformanceEntries('soft-navigation');
    const icpPromise =
        SoftNavigationTestHelper.getPerformanceEntries('interaction-contentful-paint');

    if (test_driver) {
      test_driver.click(clickTarget);
    }

    const softNavs = await this.withTimeoutMessage(
        softNavPromise, 'Soft navigation not detected.',  3000);
    assert_equals(softNavs.length, 1, 'Expected exactly one soft navigation.');
    assert_true(
      softNavs[0].name.endsWith(url),
      `Unexpected Soft Navigation URL. Expected url to end with ${url} but got ${softNavs[0].name}`);

    const icps = await this.withTimeoutMessage(
        icpPromise, 'ICP not detected.',  3000);
    assert_equals(icps.length, 1, 'Expected exactly one ICP entry.');
    assert_equals(icps[0].id, targetId, `Expected ICP candidate to be "${targetId}"`);
  }
}
