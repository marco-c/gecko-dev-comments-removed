







'use strict';



let mlContext;


promise_setup(async () => {
  assert_implements(navigator.ml, 'missing navigator.ml');
  mlContext = await navigator.ml.createContext(contextOptions);
});

const specialNameArray = [
  ['12-L#!.â˜º', 'ðŸ¤¦ðŸ¼â€â™‚ï¸124DS#!F'],

  
  ['\0node_a', '\0node_b'],
  ['node\0a', 'node\0b'],

  
  
  ['\x41\x41\x41', '\x42\x42\x42'],

  
  
  
  
  
  
  ['\u00A9\xA9\u2665\u2026', '\U0001F600']
];

specialNameArray.forEach((name) => {
  promise_test(async () => {
    
    
    
    
    
    
    
    

    const TENSOR_DIMS = [1, 2, 2, 2];
    const TENSOR_SIZE = 8;

    const builder = new MLGraphBuilder(mlContext);
    const desc = { dataType: 'float32', shape: TENSOR_DIMS };
    const constantBuffer1 = new Float32Array(TENSOR_SIZE).fill(0.5);
    const constant1 = builder.constant(desc, constantBuffer1);

    const input1 = builder.input('input1', desc);
    const constantBuffer2 = new Float32Array(TENSOR_SIZE).fill(0.5);
    const constant2 = builder.constant(desc, constantBuffer2);

    const input2 = builder.input('input2', desc);

    const intermediateOutput1 = builder.add(constant1, input1, {label: name[0]});
    const intermediateOutput2 = builder.add(constant2, input2, {label: name[1]});

    const output = builder.mul(intermediateOutput1, intermediateOutput2);
    const graph = await builder.build({'output': output});

    const inputBuffer1 = new Float32Array(TENSOR_SIZE).fill(1);
    const inputBuffer2 = new Float32Array(TENSOR_SIZE).fill(1);

    desc.writable = true;
    const inputTensor1 = await mlContext.createTensor(desc);
    const inputTensor2 = await mlContext.createTensor(desc);
    mlContext.writeTensor(inputTensor1, inputBuffer1);
    mlContext.writeTensor(inputTensor2, inputBuffer2);

    const outputTensor = await mlContext.createTensor({
      ...desc,
      readable: true,
      writable: false,
    });

    const inputs = {
      'input1': inputTensor1,
      'input2': inputTensor2,
    };
    const outputs = {'output': outputTensor};
    mlContext.dispatch(graph, inputs, outputs);

    assert_array_equals(
      new Float32Array(await mlContext.readTensor(outputTensor)),
      Float32Array.from([2.25, 2.25, 2.25, 2.25, 2.25, 2.25, 2.25, 2.25]));
  }, `'add' nodes with special character name '${name[0]}' and '${name[1]}'`);
});
