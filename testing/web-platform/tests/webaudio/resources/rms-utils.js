(function (window) {
  
  
  
  async function measureRMSOnceWithFreshScriptProcessor(ac, src) {
    function computeRMSFloat(data) {
      let sumSq = 0;
      for (let i = 0; i < data.length; i++) {
        const v = data[i];
        sumSq += v * v;
      }
      return Math.sqrt(sumSq / data.length);
    }

    
    
    const sp = ac.createScriptProcessor(2048, 1, 1);
    src.connect(sp);
    sp.connect(ac.destination);
    const { inputBuffer } =
      await new Promise(resolve => (sp.onaudioprocess = resolve));

    src.disconnect(sp);
    sp.disconnect();
    sp.onaudioprocess = null;

    const input = inputBuffer.getChannelData(0);
    const rms = computeRMSFloat(input);
    return rms;
  }

  
  
  
  async function waitForRmsEqualToThreshold(ac, src, threshold) {
    while (true) {
      const rms = await measureRMSOnceWithFreshScriptProcessor(ac, src);
        if (rms === threshold) {
        return rms;
      }
    }
  }

  
  
  
  async function waitForRmsOverThreshold(ac, src, threshold) {
    while (true) {
      const rms = await measureRMSOnceWithFreshScriptProcessor(ac, src);
      if (rms > threshold) {
        return rms;
      }
    }
  }

  window.RMSUtils = {
    measureRMSOnceWithFreshScriptProcessor,
    waitForRmsEqualToThreshold,
    waitForRmsOverThreshold,
  };
})(window);
