const effectAllowedList = ["uninitialized", "undefined", "none", "all",
  "copy",
  "move", "link", "copyMove", "copyLink", "linkMove", "dummy"
];
const dropEffectList = ["none", "copy", "move", "link", "dummy"];






function dropEffectOnDropCallBack(event) {
  assert_equals(event.target.textContent, event.dataTransfer.dropEffect);
  assert_equals(event.target.textContent, event.dataTransfer.effectAllowed);
  return true;
}

function buildDragAndDropDivs() {
  effectAllowedList.forEach(effectAllowed => {
    document.getElementById('drag-container').innerHTML +=
      `<div id="drag-${effectAllowed}" draggable="true" ondragstart="event.dataTransfer.effectAllowed = '${effectAllowed}'">${effectAllowed}</div>`;
  });
  dropEffectList.forEach(dropEffect => {
    document.getElementById('drop-container').innerHTML +=
      `<div id="drop-${dropEffect}" ondragover="onDragOver(event, '${dropEffect}')">${dropEffect}</div>`;
  });
}

function expectedDropEffectForEffectAllowed(chosenDropEffect,
  chosenEffectAllowed) {
  
  
  
  if (chosenDropEffect == "dummy") {
    switch (chosenEffectAllowed) {
      case "undefined":
      case "uninitialized":
      case "all":
        return ["copy", "move", "link"];
      case "copyLink":
        return ["copy", "link"];
      case "linkMove":
        return ["link", "move"];
      case "copyMove":
        return ["copy", "move"];
      default:
        return [chosenEffectAllowed];
    }
  }
  return [chosenDropEffect];
}

function dropEventShouldBeSent(dropEffect, effectAllowed) {
  let expectedDropEffects = expectedDropEffectForEffectAllowed(dropEffect,
    effectAllowed);
  assert_greater_than_equal(expectedDropEffects.length, 1,
    "Expected drop effect should not be empty");
  if (effectAllowed === 'dummy' || effectAllowed === 'undefined') {
    effectAllowed = 'uninitialized';
  }
  if (effectAllowed === 'none' || expectedDropEffects[0] === 'none') {
    return false;
  }
  if (effectAllowed === 'uninitialized' || effectAllowed === 'all') {
    return true;
  }
  
  for (let effect of expectedDropEffects) {
    if (effectAllowed.toLowerCase().includes(effect)) {
      return true;
    }
  }
  return false;
}

function onDropCallBack(event, chosenDropEffect, chosenEffectAllowed) {
  const actualDropEffect = event.dataTransfer.dropEffect;
  const actualEffectAllowed = event.dataTransfer.effectAllowed;
  let expectedEffectAllowed = chosenEffectAllowed;
  if (chosenEffectAllowed === 'dummy' || chosenEffectAllowed ===
    'undefined') {
    expectedEffectAllowed = 'uninitialized';
  }
  assert_equals(actualEffectAllowed, expectedEffectAllowed,
    `chosenDropEffect: ${chosenDropEffect}, chosenEffectAllowed: ${chosenEffectAllowed}; failed effectAllowed check:`
  );
  let expectedDropEffects = expectedDropEffectForEffectAllowed(
    chosenDropEffect, actualEffectAllowed);
  
  
  if (!dropEventShouldBeSent(chosenDropEffect, chosenEffectAllowed)) {
    expectedDropEffects = ['none'];
  }
  assert_in_array(actualDropEffect, expectedDropEffects,
    `chosenDropEffect: ${chosenDropEffect}, chosenEffectAllowed: ${chosenEffectAllowed}; failed dropEffect check:`
  );
  return true;
}

function onDragOver(event, dropEffect) {
  event.dataTransfer.dropEffect = dropEffect;
  event.preventDefault();
}









function runDropEffectTestOnDragEnd(effectAllowed, dropEffect) {
  buildDragAndDropDivs();
  const dragDiv = document.getElementById("drag-" + effectAllowed);
  const dropDiv = document.getElementById("drop-" + dropEffect);
  dragEndTest(dragDiv, dropDiv, (e) => onDropCallBack(e,
      dropEffect, effectAllowed),
    `${effectAllowed} / ${dropEffect}`);
}




function runDropEffectTestOnDrop(effectAllowed, dropEffect) {
  buildDragAndDropDivs();
  const dragDiv = document.getElementById("drag-" + effectAllowed);
  const dropDiv = document.getElementById("drop-" + dropEffect);
  const shouldReceiveDropEvent = dropEventShouldBeSent(dropEffect,
    effectAllowed);
  if (shouldReceiveDropEvent) {
    dragDropTest(dragDiv, dropDiv, (e) => onDropCallBack(e,
        dropEffect, effectAllowed),
      `${effectAllowed} / ${dropEffect}`);
  } else {
    dragDropTestNoDropEvent(dragDiv, dropDiv,
      `${effectAllowed} / ${dropEffect}`);
  }
}
