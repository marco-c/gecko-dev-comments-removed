

add_task(async function testHitLimitBeforeEncode() {
  await SpecialPowers.pushPrefEnv({
    set: [
      ["dom.expose_test_interfaces", true],
      ["dom.script_loader.bytecode_cache.enabled", true],
      ["dom.script_loader.bytecode_cache.strategy", 0],
      ["dom.script_loader.experimental.navigation_cache", false],
      
      
      
      ["browser.cache.disk.max_entry_size", Math.round((5 * 4000) / 1024)],
    ],
  });

  await runJSCacheTests([
    
    {
      title: "hit limit before encode",
      items: [
        {
          file: "file_js_cache_too_large.js",
          events: [
            ev("load:source", "file_js_cache_too_large.js"),
            ev("evaluate:classic", "file_js_cache_too_large.js"),
            ev("diskcache:disabled", "file_js_cache_too_large.js"),
          ],
        },
        {
          file: "file_js_cache_too_large.js",
          events: [
            ev("load:source", "file_js_cache_too_large.js"),
            ev("evaluate:classic", "file_js_cache_too_large.js"),
            ev("diskcache:disabled", "file_js_cache_too_large.js"),
          ],
        },
        {
          file: "file_js_cache_too_large.js",
          events: [
            ev("load:source", "file_js_cache_too_large.js"),
            ev("evaluate:classic", "file_js_cache_too_large.js"),
            ev("diskcache:disabled", "file_js_cache_too_large.js"),
          ],
        },
        {
          file: "file_js_cache_too_large.js",
          events: [
            ev("load:source", "file_js_cache_too_large.js"),
            ev("evaluate:classic", "file_js_cache_too_large.js"),
            
            
            ev("diskcache:disabled", "file_js_cache_too_large.js"),
          ],
        },
      ],
    },
  ]);

  await SpecialPowers.popPrefEnv();
});

add_task(async function testHitLimitAfterEncode() {
  await SpecialPowers.pushPrefEnv({
    set: [
      ["dom.expose_test_interfaces", true],
      ["dom.script_loader.bytecode_cache.enabled", true],
      ["dom.script_loader.bytecode_cache.strategy", 0],
      ["dom.script_loader.experimental.navigation_cache", false],
      
      
      
      
      ["browser.cache.disk.max_entry_size", Math.round((5 * 5000) / 1024)],
    ],
  });

  await runJSCacheTests([
    
    {
      title: "hit limit before encode",
      items: [
        {
          file: "file_js_cache_too_large.js",
          events: [
            ev("load:source", "file_js_cache_too_large.js"),
            ev("evaluate:classic", "file_js_cache_too_large.js"),
            ev("diskcache:disabled", "file_js_cache_too_large.js"),
          ],
        },
        {
          file: "file_js_cache_too_large.js",
          events: [
            ev("load:source", "file_js_cache_too_large.js"),
            ev("evaluate:classic", "file_js_cache_too_large.js"),
            ev("diskcache:disabled", "file_js_cache_too_large.js"),
          ],
        },
        {
          file: "file_js_cache_too_large.js",
          events: [
            ev("load:source", "file_js_cache_too_large.js"),
            ev("evaluate:classic", "file_js_cache_too_large.js"),
            ev("diskcache:disabled", "file_js_cache_too_large.js"),
          ],
        },
        {
          file: "file_js_cache_too_large.js",
          events: [
            ev("load:source", "file_js_cache_too_large.js"),
            ev("evaluate:classic", "file_js_cache_too_large.js"),
            ev("diskcache:register", "file_js_cache_too_large.js"),
            
            
            ev("diskcache:toolarge", "file_js_cache_too_large.js", false),
          ],
        },
        {
          file: "file_js_cache_too_large.js",
          events: [
            ev("load:source", "file_js_cache_too_large.js"),
            ev("evaluate:classic", "file_js_cache_too_large.js"),
            ev("diskcache:register", "file_js_cache_too_large.js"),
            ev("diskcache:toolarge", "file_js_cache_too_large.js", false),
          ],
        },
      ],
    },
  ]);

  await SpecialPowers.popPrefEnv();
});
