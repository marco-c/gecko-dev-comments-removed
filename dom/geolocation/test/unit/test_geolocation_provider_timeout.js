const { HttpServer } = ChromeUtils.importESModule(
  "resource://testing-common/httpd.sys.mjs"
);

async function getCurrentMetrics() {
  
  
  return {
    ipCount:
      await Glean.geolocation.geolocationService.network_ip.testGetValue(),
  };
}

var httpserver = null;
var geolocation = null;

function geoHandler(metadata, response) {
  response.processAsync();
}

function successCallback() {
  
  Assert.ok(false);
  do_test_finished();
}

async function errorCallback() {
  Assert.ok(true);
  
  let metrics = await getCurrentMetrics();
  Assert.equal(metrics.ipCount, 1);
  do_test_finished();
}

async function run_test() {
  do_test_pending();

  
  do_get_profile();
  Services.fog.initializeFOG();

  httpserver = new HttpServer();
  httpserver.registerPathHandler("/geo", geoHandler);
  httpserver.start(-1);
  Services.prefs.setCharPref(
    "geo.provider.network.url",
    "http://localhost:" + httpserver.identity.primaryPort + "/geo"
  );
  Services.prefs.setBoolPref("geo.provider.network.scan", false);

  
  Services.prefs.setIntPref("geo.provider.network.timeout", 5);

  geolocation = Cc["@mozilla.org/geolocation;1"].getService(Ci.nsISupports);
  geolocation.getCurrentPosition(successCallback, errorCallback);
}
