


"use strict";



const testPos = { x: 234, y: 345 };

const testSize = { width: 300, height: 300 };

add_task(async function sanity_check_position_size_fit() {
  const { availLeft, availTop, availHeight, availWidth } = screen;
  const xMost = availLeft + availWidth;
  const yMost = availTop + availHeight;

  
  
  Assert.less(
    testPos.x + testSize.width,
    xMost,
    "Popup x+width must fit to screen"
  );
  Assert.less(
    testPos.y + testSize.height,
    yMost,
    "Popup y+height must fit to screen"
  );
});

add_task(async function sanity_check_popup_sizing() {
  
  
  
  const tab = await BrowserTestUtils.openNewForegroundTab({ gBrowser });
  const browser = tab.linkedBrowser;

  const chromePopupPromise = BrowserTestUtils.waitForNewWindow();
  await SpecialPowers.spawn(browser, [testPos, testSize], async (pos, size) => {
    content.open(
      "",
      "_blank",
      `top=${pos.y},left=${pos.x},width=${size.width},height=${size.height}`
    );
  });
  const chromePopup = await chromePopupPromise;

  is(chromePopup.screenX, testPos.x, "Expected popup screenX");
  is(chromePopup.screenY, testPos.y, "Expected popup screenY");

  await BrowserTestUtils.closeWindow(chromePopup);
  BrowserTestUtils.removeTab(tab);
});

add_task(async function test_PiP_remembers_position() {
  const [tab, chromePiP] = await newTabWithPiP(testSize);

  Assert.notEqual(
    chromePiP.screenX,
    testPos.x,
    "PiP not initially at test position"
  );
  Assert.notEqual(
    chromePiP.screenY,
    testPos.y,
    "PiP not initially at test position"
  );

  await movePiP(chromePiP, testPos);

  
  info("Re-opening PiP window");
  await BrowserTestUtils.closeWindow(chromePiP);
  const chromePiP2Promise = BrowserTestUtils.waitForNewWindow();
  await SpecialPowers.spawn(tab.linkedBrowser, [testSize], async size => {
    content.document.notifyUserGestureActivation();
    await content.documentPictureInPicture.requestWindow(size);
  });
  const chromePiP2 = await chromePiP2Promise;

  
  is(chromePiP2.screenX, testPos.x, "Expected PiP screenX");
  is(chromePiP2.screenY, testPos.y, "Expected PiP screenY");

  await BrowserTestUtils.closeWindow(chromePiP2);
  BrowserTestUtils.removeTab(tab);
});
