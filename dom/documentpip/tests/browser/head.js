


async function newTabWithPiP(requestOptions = {}) {
  
  const tab = await BrowserTestUtils.openNewForegroundTab({
    gBrowser,
    opening: "https://example.com",
    waitForLoad: true,
  });
  const browser = tab.linkedBrowser;

  
  const chromePiPPromise = BrowserTestUtils.waitForNewWindow();
  await SpecialPowers.spawn(browser, [requestOptions], async options => {
    content.document.notifyUserGestureActivation();
    await content.documentPictureInPicture.requestWindow(options);
  });
  const chromePiP = await chromePiPPromise;

  return [tab, chromePiP];
}


async function movePiP(chromePiP, { x, y }) {
  const browser = chromePiP.gBrowser.selectedBrowser;

  
  await SpecialPowers.spawn(browser, [x, y], async (_x, _y) => {
    const obs = SpecialPowers.Services.obs;
    const topic = "docshell-position-size-changed";
    content.__observerPromise = new Promise(resolve => {
      function notify() {
        if (content.screenX == _x && content.screenY == _y) {
          obs.removeObserver(notify, topic);
          resolve();
        }
      }
      obs.addObserver(notify, topic);
    });
  });

  chromePiP.moveTo(x, y);

  
  await SpecialPowers.spawn(browser, [], async () => {
    await content.__observerPromise;
    delete content.__observerPromise;
  });
}
