


"use strict";

const ORIGIN = "https://example.com";
const TEST_PAGE =
  ORIGIN + "/browser/browser/base/content/test/permissions/empty.html";

add_setup(async function () {
  
  await SpecialPowers.pushPrefEnv({
    set: [
      [
        "permissions.desktop-notification.telemetry.siteCategories",
        JSON.stringify({
          "example.com": "social",
          "example.org": "news_publishers",
        }),
      ],
    ],
  });

  registerCleanupFunction(() => {
    Services.fog.testResetFOG();
  });
});





add_task(async function test_prompt_shown_script() {
  Services.fog.testResetFOG();

  await BrowserTestUtils.withNewTab(TEST_PAGE, async function (browser) {
    let popupshown = BrowserTestUtils.waitForEvent(
      PopupNotifications.panel,
      "popupshown"
    );

    
    await SpecialPowers.spawn(browser, [], async function () {
      
      await content.document.notifyUserGestureActivation();
      content.Notification.requestPermission();
    });

    await popupshown;

    
    let events = Glean.webNotificationPermission.promptShown.testGetValue();
    ok(events, "Should have prompt_shown events");
    is(events?.length, 1, "Should have recorded one prompt_shown event");
    is(
      events[0].extra.trigger,
      "script",
      "Trigger should be 'script' for requests with user gesture"
    );
    is(
      events[0].extra.site_category,
      "social",
      "Site category should be 'social' for example.com"
    );

    
    let notification = PopupNotifications.panel.firstElementChild;
    notification.secondaryButton.click();
  });

  
  let uri = Services.io.newURI(TEST_PAGE);
  PermissionTestUtils.remove(uri, "desktop-notification");
});





add_task(async function test_prompt_blocked() {
  Services.fog.testResetFOG();

  await SpecialPowers.pushPrefEnv({
    set: [
      ["dom.webnotifications.requireuserinteraction", true],
      ["permissions.desktop-notification.postPrompt.enabled", false],
    ],
  });

  await BrowserTestUtils.withNewTab(TEST_PAGE, async function (browser) {
    
    
    await SpecialPowers.spawn(browser, [], async function () {
      let result = await content.Notification.requestPermission();
      
      is(
        result,
        "default",
        "Permission should be auto-denied to default state"
      );
    });

    
    let events = Glean.webNotificationPermission.promptBlocked.testGetValue();
    ok(events, "Should have recorded prompt_blocked events");
    is(events?.length, 1, "Should have recorded one prompt_blocked event");
    is(
      events[0].extra.reason,
      "no_user_gesture",
      "Reason should be 'no_user_gesture'"
    );
    is(
      events[0].extra.site_category,
      "social",
      "Site category should be 'social' for example.com"
    );
  });

  await SpecialPowers.popPrefEnv();

  
  let uri = Services.io.newURI(TEST_PAGE);
  PermissionTestUtils.remove(uri, "desktop-notification");
});





add_task(async function test_prompt_interaction_allow() {
  Services.fog.testResetFOG();

  let uri = Services.io.newURI(TEST_PAGE);

  await BrowserTestUtils.withNewTab(TEST_PAGE, async function (browser) {
    let popupshown = BrowserTestUtils.waitForEvent(
      PopupNotifications.panel,
      "popupshown"
    );

    
    await SpecialPowers.spawn(browser, [], async function () {
      await content.document.notifyUserGestureActivation();
      content.Notification.requestPermission();
    });

    await popupshown;

    
    let notification = PopupNotifications.panel.firstElementChild;
    EventUtils.synthesizeMouseAtCenter(notification.button, {});

    
    let events =
      Glean.webNotificationPermission.promptInteraction.testGetValue();
    ok(events, "Should have prompt_interaction events");
    is(events?.length, 1, "Should have recorded one prompt_interaction event");
    is(events[0].extra.action, "allow", "Action should be 'allow'");
    is(
      events[0].extra.is_persistent,
      "true",
      "Should be persistent by default"
    );
    is(
      events[0].extra.site_category,
      "social",
      "Site category should be 'social' for example.com"
    );

    
    is(
      PermissionTestUtils.testPermission(uri, "desktop-notification"),
      Ci.nsIPermissionManager.ALLOW_ACTION,
      "Permission should be granted"
    );

    
    PermissionTestUtils.remove(uri, "desktop-notification");
  });
});





add_task(async function test_prompt_interaction_block() {
  Services.fog.testResetFOG();

  let uri = Services.io.newURI(TEST_PAGE);

  await BrowserTestUtils.withNewTab(TEST_PAGE, async function (browser) {
    let popupshown = BrowserTestUtils.waitForEvent(
      PopupNotifications.panel,
      "popupshown"
    );

    
    await SpecialPowers.spawn(browser, [], async function () {
      await content.document.notifyUserGestureActivation();
      content.Notification.requestPermission();
    });

    await popupshown;

    
    let notification = PopupNotifications.panel.firstElementChild;
    EventUtils.synthesizeMouseAtCenter(notification.secondaryButton, {});

    
    let events =
      Glean.webNotificationPermission.promptInteraction.testGetValue();
    ok(events, "Should have prompt_interaction events");
    is(events?.length, 1, "Should have recorded one prompt_interaction event");
    is(events[0].extra.action, "block", "Action should be 'block'");
    is(
      events[0].extra.is_persistent,
      "true",
      "Should be persistent by default"
    );
    is(
      events[0].extra.site_category,
      "social",
      "Site category should be 'social' for example.com"
    );

    
    is(
      PermissionTestUtils.testPermission(uri, "desktop-notification"),
      Ci.nsIPermissionManager.DENY_ACTION,
      "Permission should be denied"
    );

    
    PermissionTestUtils.remove(uri, "desktop-notification");
  });
});






add_task(async function test_site_categorization() {
  Services.fog.testResetFOG();

  await BrowserTestUtils.withNewTab(TEST_PAGE, async function (browser) {
    let popupshown = BrowserTestUtils.waitForEvent(
      PopupNotifications.panel,
      "popupshown"
    );

    await SpecialPowers.spawn(browser, [], async function () {
      await content.document.notifyUserGestureActivation();
      content.Notification.requestPermission();
    });

    await popupshown;

    
    let events = Glean.webNotificationPermission.promptShown.testGetValue();
    ok(events, "Should have prompt_shown events");
    is(events?.length, 1, "Should have recorded one prompt_shown event");
    is(
      events[0].extra.site_category,
      "social",
      "Site category should be 'social' for example.com"
    );

    
    let notification = PopupNotifications.panel.firstElementChild;
    notification.secondaryButton.click();
  });

  
  let uri = Services.io.newURI(TEST_PAGE);
  PermissionTestUtils.remove(uri, "desktop-notification");
});





add_task(async function test_permission_revoked_toolbar() {
  Services.fog.testResetFOG();

  let uri = Services.io.newURI(TEST_PAGE);

  
  PermissionTestUtils.add(
    uri,
    "desktop-notification",
    Services.perms.ALLOW_ACTION
  );

  await BrowserTestUtils.withNewTab(TEST_PAGE, async function () {
    
    await openPermissionPopup();

    
    let permissionList = document.getElementById(
      "permission-popup-permission-list"
    );
    let notificationItem = permissionList.querySelector(
      ".permission-popup-permission-item-desktop-notification"
    );
    ok(notificationItem, "Should find notification permission item in panel");

    let removeButton = notificationItem.querySelector(
      ".permission-popup-permission-remove-button"
    );
    ok(removeButton, "Should find remove button");

    removeButton.click();

    
    let events =
      Glean.webNotificationPermission.permissionRevokedToolbar.testGetValue();
    ok(events, "Should have permission_revoked_toolbar events");
    is(
      events?.length,
      1,
      "Should have recorded one permission_revoked_toolbar event"
    );
    is(
      events[0].extra.site_category,
      "social",
      "Site category should be 'social' for example.com"
    );

    
    await closePermissionPopup();
  });

  
  PermissionTestUtils.remove(uri, "desktop-notification");
});
