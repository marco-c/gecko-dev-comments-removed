





"use strict";

const SMARTBLOCK_EMBED_OBSERVER_TIMEOUT_MS = 10000;





const embedHelperLib = (() => {
  let prevRanShims = new Set();
  let originalEmbedContainers = [];
  let embedPlaceholders = [];
  let modifiedContainers = [];
  let observerTimeout;
  let newEmbedObserver;

  function sendMessageToAddon(message, shimId) {
    return browser.runtime.sendMessage({ message, shimId });
  }

  function addonMessageHandler(message, SHIM_INFO) {
    const { topic, shimId: sendingShimId } = message;
    const { shimId: handlingShimId, scriptURL } = SHIM_INFO;

    
    if (sendingShimId != handlingShimId) {
      return;
    }

    if (topic === "smartblock:unblock-embed") {
      if (newEmbedObserver) {
        newEmbedObserver.disconnect();
        newEmbedObserver = null;
      }

      if (observerTimeout) {
        clearTimeout(observerTimeout);
        observerTimeout = null;
      }

      
      embedPlaceholders.forEach((placeholder, idx) => {
        const modifiedContainer = modifiedContainers[idx];
        const originalContainer = originalEmbedContainers[idx];

        
        modifiedContainer.replaceWith(originalContainer);
      });

      
      embedPlaceholders = [];
      modifiedContainers = [];
      originalEmbedContainers = [];

      
      let scriptElement = document.createElement("script");

      
      
      
      scriptElement.wrappedJSObject.src = scriptURL;
      document.body.appendChild(scriptElement);
    }
  }

  









  async function createShimPlaceholders(embedContainers, SHIM_INFO) {
    const { shimId, embedSelector, embedLogoURL, isTestShim } = SHIM_INFO;

    
    
    const shouldShowEmbedContent = await sendMessageToAddon(
      "shouldShowEmbedContentInPlaceholders",
      shimId
    );

    const [titleString, descriptionString, buttonString] =
      await sendMessageToAddon("smartblockGetFluentString", shimId);

    if (!embedContainers.length) {
      
      embedContainers = document.querySelectorAll(embedSelector);
    }

    embedContainers.forEach(originalContainer => {
      
      
      const SMARTBLOCK_PLACEHOLDER_HTML_STRING = `
        <style>
          #smartblock-placeholder-wrapper {
            min-height: 137px;
            min-width: 150px;
            max-height: 225px;
            max-width: 400px;
            padding: 32px 24px;
  
            display: block;
            align-content: center;
            text-align: center;
  
            background-color: light-dark(rgb(255, 255, 255), rgb(28, 27, 34));
            color: light-dark(rgb(43, 42, 51), rgb(251, 251, 254));
  
            border-radius: 8px;
            border: 2px dashed #0250bb;
  
            font-size: 14px;
            line-height: 1.2;
            font-family: system-ui;
          }
  
          #smartblock-placeholder-button {
            min-height: 32px;
            padding: 8px 14px;
  
            border-radius: 4px;
            font-weight: 600;
            border: 0;
  
            /* Colours match light/dark theme from
              https://searchfox.org/mozilla-central/source/browser/themes/addons/light/manifest.json
              https://searchfox.org/mozilla-central/source/browser/themes/addons/dark/manifest.json */
            background-color: light-dark(rgb(0, 97, 224), rgb(0, 221, 255));
            color: light-dark(rgb(251, 251, 254), rgb(43, 42, 51));
          }
  
          #smartblock-placeholder-button:hover {
            /* Colours match light/dark theme from
              https://searchfox.org/mozilla-central/source/browser/themes/addons/light/manifest.json
              https://searchfox.org/mozilla-central/source/browser/themes/addons/dark/manifest.json */
            background-color: light-dark(rgb(2, 80, 187), rgb(128, 235, 255));
          }

          #smartblock-placeholder-button:hover:active {
            /* Colours match light/dark theme from
              https://searchfox.org/mozilla-central/source/browser/themes/addons/light/manifest.json
              https://searchfox.org/mozilla-central/source/browser/themes/addons/dark/manifest.json */
            background-color: light-dark(rgb(5, 62, 148), rgb(170, 242, 255));
          }
  
          #smartblock-placeholder-title {
            margin-block: 14px;
            font-size: 16px;
            font-weight: bold;
          }
  
          #smartblock-placeholder-desc {
            margin-block: 14px;
          }
        </style>
        <div id="smartblock-placeholder-wrapper">
          <img id="smartblock-placeholder-image" width="24" height="24" />
          <p id="smartblock-placeholder-title"></p>
          <p id="smartblock-placeholder-desc"></p>
          <button id="smartblock-placeholder-button"></button>
        </div>`;

      
      const placeholderDiv = document.createElement("div");

      
      
      disableSetPointerCaptureFor(placeholderDiv);

      if (isTestShim) {
        
        placeholderDiv.classList.add("shimmed-embedded-content");
      }

      const shadowRoot = placeholderDiv.attachShadow({ mode: "closed" });

      shadowRoot.innerHTML = SMARTBLOCK_PLACEHOLDER_HTML_STRING;
      shadowRoot.getElementById("smartblock-placeholder-image").src =
        embedLogoURL;
      shadowRoot.getElementById("smartblock-placeholder-title").textContent =
        titleString;
      shadowRoot.getElementById("smartblock-placeholder-desc").textContent =
        descriptionString;
      shadowRoot.getElementById("smartblock-placeholder-button").textContent =
        buttonString;

      
      shadowRoot
        .getElementById("smartblock-placeholder-button")
        .addEventListener("click", ({ isTrusted }) => {
          if (!isTrusted) {
            return;
          }
          
          
          sendMessageToAddon("embedClicked", shimId);
        });

      
      let replacementElement;

      if (shouldShowEmbedContent) {
        
        
        const safeContentContainer = document.createElement("div");

        
        safeContentContainer.style.cssText = `
          margin-top: 12px;
          padding: 12px;
          background-color: light-dark(rgb(248, 248, 248), rgb(42, 42, 46));
          border-radius: 4px;
          font-size: 14px;
          line-height: 1.5;
          color: light-dark(rgb(43, 42, 51), rgb(251, 251, 254));
          font-family: system-ui, -apple-system, sans-serif;
        `;

        
        
        
        
        const sanitizer = new Sanitizer({
          replaceWithChildrenElements: [
            "abbr",
            "address",
            "article",
            "aside",
            "b",
            "bdi",
            "bdo",
            "blockquote",
            "body",
            "caption",
            "cite",
            "code",
            "col",
            "colgroup",
            "data",
            "dd",
            "del",
            "dfn",
            "div",
            "dl",
            "dt",
            "em",
            "figcaption",
            "figure",
            "footer",
            "h1",
            "h2",
            "h3",
            "h4",
            "h5",
            "h6",
            "head",
            "header",
            "hgroup",
            "hr",
            "html",
            "i",
            "ins",
            "kbd",
            "li",
            "main",
            "mark",
            "menu",
            "nav",
            "ol",
            "p",
            "pre",
            "q",
            "rp",
            "rt",
            "ruby",
            "s",
            "samp",
            "search",
            "section",
            "small",
            "span",
            "strong",
            "sub",
            "sup",
            "table",
            "tbody",
            "td",
            "tfoot",
            "th",
            "thead",
            "time",
            "title",
            "tr",
            "u",
            "ul",
            "var",
            "wbr",
          ],
        });

        
        const contentDiv = document.createElement("div");
        contentDiv.setHTML(originalContainer.innerHTML, { sanitizer });

        
        
        contentDiv.querySelectorAll("a[href]").forEach(link => {
          try {
            const url = new URL(link.href, document.baseURI);
            if (url.protocol !== "https:") {
              link.removeAttribute("href");
            }
          } catch {
            link.removeAttribute("href");
          }
        });

        
        contentDiv.querySelectorAll("a[href]").forEach(link => {
          link.target = "_blank";
          link.rel = "noopener noreferrer";
          link.style.cssText = `
            color: light-dark(rgb(0, 97, 224), rgb(0, 221, 255));
            text-decoration: underline;
            cursor: pointer;
          `;
        });

        
        const explanationDiv = document.createElement("div");
        explanationDiv.textContent = "Content from blocked embed:";
        explanationDiv.style.cssText = `
          font-size: 12px;
          font-weight: 600;
          color: light-dark(rgb(91, 91, 102), rgb(191, 191, 201));
          margin-bottom: 8px;
        `;
        safeContentContainer.appendChild(explanationDiv);
        safeContentContainer.appendChild(contentDiv);

        
        const wrapperDiv = document.createElement("div");
        wrapperDiv.appendChild(placeholderDiv);
        wrapperDiv.appendChild(safeContentContainer);

        replacementElement = wrapperDiv;
      } else {
        
        replacementElement = placeholderDiv;
      }

      
      embedPlaceholders.push(replacementElement);
      modifiedContainers.push(replacementElement);
      originalEmbedContainers.push(originalContainer);

      
      originalContainer.replaceWith(replacementElement);

      sendMessageToAddon("smartblockEmbedReplaced", shimId);
    });

    if (isTestShim) {
      
      const finishedEvent = new CustomEvent("smartblockEmbedScriptFinished", {
        bubbles: true,
        composed: true,
      });
      window.dispatchEvent(finishedEvent);
    }
  }

  





  function createEmbedMutationObserver(SHIM_INFO) {
    const { embedSelector } = SHIM_INFO;

    
    
    newEmbedObserver = new MutationObserver(mutations => {
      for (let { addedNodes, target, type } of mutations) {
        const nodes = type === "attributes" ? [target] : addedNodes;
        for (const node of nodes) {
          if (node.nodeType !== Node.ELEMENT_NODE) {
            
            continue;
          }
          if (node.matches(embedSelector)) {
            
            createShimPlaceholders([node], SHIM_INFO);
          } else {
            
            
            let maybeEmbedNodeList = node.querySelectorAll?.(embedSelector);
            if (maybeEmbedNodeList) {
              createShimPlaceholders(maybeEmbedNodeList, SHIM_INFO);
            }
          }
        }
      }
    });

    newEmbedObserver.observe(document.documentElement, {
      childList: true,
      subtree: true,
      attributes: true,
      attributeFilter: ["id", "class"],
    });

    
    observerTimeout = setTimeout(() => {
      if (newEmbedObserver) {
        newEmbedObserver.disconnect();
      }
    }, SMARTBLOCK_EMBED_OBSERVER_TIMEOUT_MS);
  }

  





  function disableSetPointerCaptureFor(el) {
    const pageEl = el.wrappedJSObject;

    Object.defineProperty(pageEl, "setPointerCapture", {
      configurable: true,
      writable: true,
      enumerable: false,
      
      value: exportFunction(function (_pointerId) {
        console.warn(
          "Blocked setPointerCapture on SmartBlock embed placeholder.",
          this,
          _pointerId
        );
        
      }, window),
    });
  }

  




  function initEmbedShim(SHIM_INFO) {
    let { shimId } = SHIM_INFO;

    if (prevRanShims.has(shimId)) {
      
      return;
    }

    prevRanShims.add(shimId);

    
    browser.runtime.onMessage.addListener(request => {
      addonMessageHandler(request, SHIM_INFO);
    });

    
    createEmbedMutationObserver(SHIM_INFO);

    
    createShimPlaceholders([], SHIM_INFO);
  }

  return {
    initEmbedShim,
  };
})();
