"use strict";





const PERMISSIONS_URL =
  "chrome://browser/content/preferences/dialogs/sitePermissions.xhtml";
const PERMISSION_TYPES = [
  
  "geo",
  
  "camera",
  
  "microphone",
  
  "speaker",
  
  "desktop-notification",
  
  "autoplay-media",
  
  "xr",
];





async function assertEntries({
  domain = null,
  scheme = null,
  permissionType,
  count,
  contextMsg,
}) {
  if (Boolean(domain) === Boolean(scheme)) {
    throw new Error(
      "For assertEntries you MUST specify either domain OR scheme."
    );
  }

  let dialogWin = await openAndLoadSubDialog(PERMISSIONS_URL, null, {
    permissionType,
  });
  await dialogWin.document.mozSubdialogReady;

  let richlistbox = dialogWin.document.getElementById("permissionsBox");
  let filterFunction = domain
    ? origin => origin?.includes(domain)
    : origin => origin?.startsWith(scheme);
  let domainOrigins = Array.from(richlistbox.querySelectorAll("richlistitem"))
    .map(item => item.getAttribute("origin"))
    .filter(filterFunction);

  Assert.equal(
    domainOrigins.length,
    count,
    `${contextMsg}: ${count} ${domain ? domain : scheme} entries should be shown for permissionType=${permissionType}.`
  );

  let closePromise = BrowserTestUtils.waitForEvent(
    dialogWin,
    "dialogclosing",
    true
  );
  dialogWin.document.querySelector("dialog").getButton("cancel").click();
  await closePromise;
}

add_task(async function test_no_about_entries_in_site_permissions_dialogs() {
  let privacyPane;

  registerCleanupFunction(() => {
    Services.perms.removeAll();
    if (privacyPane) {
      BrowserTestUtils.removeTab(gBrowser.selectedTab);
    }
  });

  
  privacyPane = await openPreferencesViaOpenPreferencesAPI("privacy", {
    leaveOpen: true,
  });
  for (let type of PERMISSION_TYPES) {
    await assertEntries({
      scheme: "about:",
      permissionType: type,
      count: 0,
      contextMsg: "Initial",
    });
  }

  
  PermissionTestUtils.add("about:welcome", "geo", Services.perms.ALLOW_ACTION);
  PermissionTestUtils.add(
    "https://example.com",
    "geo",
    Services.perms.ALLOW_ACTION
  );

  
  await assertEntries({
    scheme: "about:",
    permissionType: "geo",
    count: 0,
    contextMsg: "After adding about:welcome Location permission",
  });
  
  await assertEntries({
    domain: "example.com",
    permissionType: "geo",
    count: 1,
    contextMsg: "After adding https://example.com Location permission",
  });
});
