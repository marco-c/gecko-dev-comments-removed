


"use strict";

const { IPProtectionToolbarButton } = ChromeUtils.importESModule(
  "moz-src:///browser/components/ipprotection/IPProtectionToolbarButton.sys.mjs"
);





add_task(function test_update_icon_status() {
  const browser = Services.appShell.createWindowlessBrowser(true);
  const principal = Services.scriptSecurityManager.getSystemPrincipal();
  browser.docShell.createAboutBlankDocumentViewer(principal, principal);
  const document = browser.docShell.docViewer.DOMDocument;

  
  const fakeWindow = {
    gBrowser: {
      addTabsProgressListener: () => {},
      removeTabsProgressListener: () => {},
      contentPrincipal: principal,
    },
    document,
  };

  let fakeToolbarItem = document.createXULElement("toolbaritem");
  
  let fakeToolbarButton = new IPProtectionToolbarButton(
    fakeWindow,
    "test-toolbarbutton"
  );

  Assert.equal(
    fakeToolbarItem.classList.length,
    0,
    "Toolbaritem class list should be empty"
  );

  
  fakeToolbarButton.updateIconStatus(fakeToolbarItem, {
    isActive: true,
    isError: false,
    isExcluded: false,
  });

  Assert.ok(
    fakeToolbarItem.classList.contains("ipprotection-on"),
    "Toolbaritem classlist should include ipprotection-on"
  );

  
  
  fakeToolbarButton.updateIconStatus(fakeToolbarItem, {
    isActive: true,
    isError: false,
    isExcluded: true,
  });

  Assert.ok(
    fakeToolbarItem.classList.contains("ipprotection-excluded"),
    "Toolbaritem classlist should include ipprotection-excluded"
  );

  
  
  fakeToolbarButton.updateIconStatus(fakeToolbarItem, {
    isActive: true,
    isError: true,
    isExcluded: false,
  });

  Assert.ok(
    fakeToolbarItem.classList.contains("ipprotection-error"),
    "Toolbaritem classlist should include ipprotection-error"
  );
  Assert.ok(
    !fakeToolbarItem.classList.contains("ipprotection-on"),
    "Toolbaritem classlist should not include ipprotection-on"
  );
  Assert.ok(
    !fakeToolbarItem.classList.contains("ipprotection-excluded"),
    "Toolbaritem classlist should not include ipprotection-excluded"
  );

  
  fakeToolbarButton.updateIconStatus(fakeToolbarItem, {
    isActive: false,
    isError: false,
    isExcluded: false,
  });

  Assert.ok(
    !fakeToolbarItem.classList.contains("ipprotection-error"),
    "Toolbaritem classlist should not include ipprotection-error"
  );
  Assert.ok(
    !fakeToolbarItem.classList.contains("ipprotection-on"),
    "Toolbaritem classlist should not include ipprotection-on"
  );
  Assert.ok(
    !fakeToolbarItem.classList.contains("ipprotection-excluded"),
    "Toolbaritem classlist should not include ipprotection-excluded"
  );

  
  fakeToolbarButton.uninit();
});
