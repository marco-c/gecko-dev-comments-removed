



"use strict";

const { LINKS } = ChromeUtils.importESModule(
  "chrome://browser/content/ipprotection/ipprotection-constants.mjs"
);
const lazy = {};

ChromeUtils.defineESModuleGetters(lazy, {
  IPProtectionWidget:
    "moz-src:///browser/components/ipprotection/IPProtection.sys.mjs",
  IPProtectionPanel:
    "moz-src:///browser/components/ipprotection/IPProtectionPanel.sys.mjs",
});

const PANELSTATES = {
  signedOutVPNOff: {
    isSignedOut: true,
    isProtectionEnabled: false,
  },
  signedInVPNOff: {
    isSignedOut: false,
    isProtectionEnabled: false,
  },
  signedInVPNOn: {
    isSignedOut: false,
    isProtectionEnabled: true,
  },
};

async function setAndUpdateIsSignedOut(content, isSignedOut) {
  content.state.isSignedOut = isSignedOut;
  content.requestUpdate();
  await content.updateComplete;
}

async function resetStateToObj(content, originalState) {
  content.state = originalState;
  content.requestUpdate();
  await content.updateComplete;
}




add_task(async function test_main_content() {
  let button = document.getElementById(lazy.IPProtectionWidget.WIDGET_ID);
  let panelView = PanelMultiView.getViewNode(
    document,
    lazy.IPProtectionWidget.PANEL_ID
  );

  let panelShownPromise = waitForPanelEvent(document, "popupshown");
  
  button.click();
  await panelShownPromise;

  let content = panelView.querySelector(lazy.IPProtectionPanel.CONTENT_TAGNAME);

  let originalState = structuredClone(content.state);

  await setAndUpdateIsSignedOut(content, false);

  Assert.ok(
    BrowserTestUtils.isVisible(content),
    "ipprotection content component should be present"
  );
  Assert.ok(content.statusCardEl, "Status card should be present");

  await resetStateToObj(content, originalState);

  
  let panelHiddenPromise = waitForPanelEvent(document, "popuphidden");
  EventUtils.synthesizeKey("KEY_Escape");
  await panelHiddenPromise;
});




add_task(async function test_settings_link_visibility() {
  let content = await openPanel(PANELSTATES.signedOutVPNOff);

  Assert.ok(
    !content.settingsButtonEl,
    "Settings button should NOT be present when not signed in"
  );

  await closePanel();

  content = await openPanel(PANELSTATES.signedInVPNOff);

  Assert.ok(
    content.settingsButtonEl,
    "Settings button should be present when VPN is disabled"
  );

  await closePanel();

  content = await openPanel(PANELSTATES.signedInVPNOn);

  Assert.ok(
    content.settingsButtonEl,
    "Settings button should be present when VPN is enabled"
  );

  await closePanel();
});





add_task(async function test_settings_button_closes_panel() {
  let content = await openPanel(PANELSTATES.signedInVPNOn);

  Assert.ok(BrowserTestUtils.isVisible(content), "VPN panel should be present");

  Assert.ok(content.settingsButtonEl, "Settings button should be present");

  let panelHiddenPromise = waitForPanelEvent(document, "popuphidden");

  const openPreferencesStub = sinon.stub(window, "openPreferences");

  content.settingsButtonEl.click();

  await panelHiddenPromise;

  let panelView = PanelMultiView.getViewNode(
    document,
    lazy.IPProtectionWidget.PANEL_ID
  );
  Assert.ok(!BrowserTestUtils.isVisible(panelView), "Panel should be closed");

  Assert.ok(
    openPreferencesStub.calledWith("privacy-vpn"),
    "openPreferences called with correct argument when settings button clicked"
  );
  openPreferencesStub.restore();
});
