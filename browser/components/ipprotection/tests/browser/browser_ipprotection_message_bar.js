



"use strict";




add_task(async function test_warning_message() {
  await SpecialPowers.pushPrefEnv({
    set: [
      ["browser.ipProtection.bandwidth.enabled", true],
      ["browser.ipProtection.bandwidthThreshold", 0],
    ],
  });

  
  let content = await openPanel({
    isSignedOut: false,
    error: "",
    bandwidthUsage: {
      currentBandwidthUsage: 0,
      maxBandwidth: 50,
    },
  });

  let messageBar = content.shadowRoot.querySelector("ipprotection-message-bar");

  Assert.ok(!messageBar, "Message bar should not be present initially");

  let messageBarLoadedPromise = BrowserTestUtils.waitForMutationCondition(
    content.shadowRoot,
    { childList: true, subtree: true },
    () => content.shadowRoot.querySelector("ipprotection-message-bar")
  );

  
  await setPanelState({
    isSignedOut: false,
    error: "",
    bandwidthUsage: {
      remaining: 12.5,
      max: 50,
    },
  });

  
  await SpecialPowers.pushPrefEnv({
    set: [["browser.ipProtection.bandwidthThreshold", 75]],
  });

  await messageBarLoadedPromise;

  messageBar = content.shadowRoot.querySelector("ipprotection-message-bar");

  Assert.ok(messageBar, "Message bar should be present after threshold change");
  Assert.ok(
    messageBar.mozMessageBarEl,
    "Wrapped moz-message-bar should be present"
  );
  Assert.equal(messageBar.type, "warning", "Message bar should be warning");
  Assert.equal(
    messageBar.messageId,
    "ipprotection-message-bandwidth-warning",
    "Warning message id should match"
  );

  
  Assert.ok(
    messageBar.bandwidthUsage,
    "Bandwidth usage data should be passed to message bar"
  );
  Assert.equal(
    messageBar.bandwidthUsage.remaining,
    12.5,
    "Current bandwidth remaining should match (37.5 GB used at 75% threshold)"
  );
  Assert.equal(
    messageBar.bandwidthUsage.max,
    50,
    "Max bandwidth should match (50 GB limit)"
  );

  
  let closeButton = messageBar.mozMessageBarEl.closeButton;
  Assert.ok(closeButton, "Message bar should have close button");

  let dismissEvent = BrowserTestUtils.waitForEvent(
    document,
    messageBar.DISMISS_EVENT
  );
  let messageBarUnloadedPromise = BrowserTestUtils.waitForMutationCondition(
    content.shadowRoot,
    { childList: true, subtree: true },
    () => !content.shadowRoot.querySelector("ipprotection-message-bar")
  );

  closeButton.click();

  await dismissEvent;
  await messageBarUnloadedPromise;

  Assert.ok(
    !content.shadowRoot.querySelector("ipprotection-message-bar"),
    "Message bar should be dismissed after clicking close button"
  );

  await closePanel();

  
  await SpecialPowers.pushPrefEnv({
    set: [["browser.ipProtection.bandwidthThreshold", 90]],
  });
  
  content = await openPanel({
    isSignedOut: false,
    error: "",
    bandwidthUsage: {
      remaining: 5,
      max: 50,
    },
  });

  messageBarLoadedPromise = BrowserTestUtils.waitForMutationCondition(
    content.shadowRoot,
    { childList: true, subtree: true },
    () => content.shadowRoot.querySelector("ipprotection-message-bar")
  );

  
  await messageBarLoadedPromise;

  messageBar = content.shadowRoot.querySelector("ipprotection-message-bar");

  Assert.ok(
    messageBar,
    "Message bar should reappear at 90% threshold after 75% was dismissed"
  );
  Assert.equal(messageBar.type, "warning", "Message bar should be warning");
  Assert.equal(
    messageBar.messageId,
    "ipprotection-message-bandwidth-warning",
    "Warning message id should match"
  );

  
  Assert.equal(
    messageBar.bandwidthUsage.remaining,
    5,
    "Current bandwidth usage should be updated (45 GB used at 90% threshold)"
  );
  Assert.equal(
    messageBar.bandwidthUsage.max,
    50,
    "Max bandwidth should match (50 GB limit)"
  );

  dismissEvent = BrowserTestUtils.waitForEvent(
    document,
    messageBar.DISMISS_EVENT
  );
  messageBarUnloadedPromise = BrowserTestUtils.waitForMutationCondition(
    content.shadowRoot,
    { childList: true, subtree: true },
    () => !content.shadowRoot.querySelector("ipprotection-message-bar")
  );
  closeButton = messageBar.mozMessageBarEl.closeButton;
  closeButton.click();

  await dismissEvent;
  await messageBarUnloadedPromise;

  await closePanel();
  await SpecialPowers.popPrefEnv();
});





add_task(async function test_dismiss() {
  let content = await openPanel({
    isSignedOut: false,
    error: "",
    bandwidthWarning: false,
  });

  let messageBar = content.shadowRoot.querySelector("ipprotection-message-bar");

  Assert.ok(!messageBar, "Message bar should not be present");

  let messageBarLoadedPromise = BrowserTestUtils.waitForMutationCondition(
    content.shadowRoot,
    { childList: true, subtree: true },
    () => content.shadowRoot.querySelector("ipprotection-message-bar")
  );

  
  await setPanelState({
    isSignedOut: false,
    error: "",
    bandwidthWarning: true,
  });
  await messageBarLoadedPromise;

  messageBar = content.shadowRoot.querySelector("ipprotection-message-bar");

  Assert.ok(messageBar, "Message bar should be present");
  Assert.ok(
    messageBar.mozMessageBarEl,
    "Wrapped moz-message-bar should be present"
  );

  let closeButton = messageBar.mozMessageBarEl.closeButton;

  Assert.ok(closeButton, "Message bar should have close button");

  let dismissEvent = BrowserTestUtils.waitForEvent(
    document,
    messageBar.DISMISS_EVENT
  );
  let messageBarUnloadedPromise = BrowserTestUtils.waitForMutationCondition(
    content.shadowRoot,
    { childList: true, subtree: true },
    () => !content.shadowRoot.querySelector("ipprotection-message-bar")
  );

  closeButton.click();

  await dismissEvent;
  Assert.ok(true, "Dismiss event was dispatched");

  await messageBarUnloadedPromise;
  Assert.ok(true, "Message bar should be not be present");

  await closePanel();
});
