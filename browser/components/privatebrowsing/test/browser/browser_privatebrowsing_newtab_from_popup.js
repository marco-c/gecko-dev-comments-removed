







const PATH = getRootDirectory(gTestPath).replace(
  "chrome://mochitests/content",
  "https://example.com"
);
const POPUP_LINK = PATH + "file_newtab_from_popup.html";
const WINDOW_SOURCE = PATH + "file_newtab_from_popup_source.html";

add_task(async function test_private_popup_window_opens_private_tabs() {
  let privWin = await BrowserTestUtils.openNewBrowserWindow({ private: true });

  
  ok(
    PrivateBrowsingUtils.isWindowPrivate(privWin),
    "Opened a private browsing window."
  );

  
  
  let privBrowser = privWin.gBrowser.selectedBrowser;
  BrowserTestUtils.startLoadingURIString(privBrowser, WINDOW_SOURCE);
  await BrowserTestUtils.browserLoaded(privBrowser);

  
  
  let openedPromise = BrowserTestUtils.waitForNewWindow({ url: POPUP_LINK });

  await BrowserTestUtils.synthesizeMouseAtCenter("#first", {}, privBrowser);
  let popupWin = await openedPromise;
  ok(
    PrivateBrowsingUtils.isWindowPrivate(popupWin),
    "Popup window was private."
  );

  
  
  let newTabPromise = BrowserTestUtils.waitForNewTab(privWin.gBrowser);
  let popupBrowser = popupWin.gBrowser.selectedBrowser;
  await BrowserTestUtils.synthesizeMouseAtCenter("#second", {}, popupBrowser);
  let newPrivTab = await newTabPromise;

  
  ok(
    PrivateBrowsingUtils.isBrowserPrivate(newPrivTab.linkedBrowser),
    "Newly opened tab should be private."
  );

  
  BrowserTestUtils.removeTab(newPrivTab);
  await BrowserTestUtils.closeWindow(popupWin);
  await BrowserTestUtils.closeWindow(privWin);
});
