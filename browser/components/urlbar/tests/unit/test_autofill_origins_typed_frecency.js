



"use strict";






ChromeUtils.defineLazyGetter(this, "PlacesFrecencyRecalculator", () => {
  return Cc["@mozilla.org/places/frecency-recalculator;1"].getService(
    Ci.nsIObserver
  ).wrappedJSObject;
});

registerCleanupFunction(async () => {
  Services.prefs.clearUserPref("browser.urlbar.suggest.quickactions");
});
Services.prefs.setBoolPref("browser.urlbar.suggest.quickactions", false);

testEngine_setup();


add_task(async function nonTypedVisits_noAutofill_transition() {
  await PlacesTestUtils.addVisits([
    {
      uri: "http://example1.com/",
      transition: PlacesUtils.history.TRANSITION_LINK,
    },
    {
      uri: "https://example2.com/",
      transition: PlacesUtils.history.TRANSITION_REDIRECT_PERMANENT,
    },
    {
      uri: "https://example3.com/",
      transition: PlacesUtils.history.TRANSITION_REDIRECT_TEMPORARY,
    },
    {
      uri: "https://example4.com/path/",
      transition: PlacesUtils.history.TRANSITION_LINK,
    },
    {
      
      uri: "https://example-reload.com/",
      transition: PlacesUtils.history.TRANSITION_RELOAD,
    },
    {
      
      uri: "https://example-bookmarked.com/path/",
      transition: PlacesUtils.history.TRANSITION_BOOKMARK,
    },
  ]);

  await PlacesFrecencyRecalculator.recalculateAnyOutdatedFrecencies();

  let context = createContext("ex", { isPrivate: false });
  await check_results({
    context,
    matches: [
      makeSearchResult(context, {
        engineName: "Suggestions",
        heuristic: true,
      }),
      makeVisitResult(context, {
        uri: "https://example-bookmarked.com/path/",
        title: "test visit for https://example-bookmarked.com/path/",
      }),
      makeVisitResult(context, {
        uri: "https://example4.com/path/",
        title: "test visit for https://example4.com/path/",
      }),
      makeVisitResult(context, {
        uri: "https://example3.com/",
        title: "test visit for https://example3.com/",
      }),
      makeVisitResult(context, {
        uri: "https://example2.com/",
        title: "test visit for https://example2.com/",
      }),
      makeVisitResult(context, {
        uri: "http://example1.com/",
        title: "test visit for http://example1.com/",
      }),
    ],
  });

  await cleanupPlaces();
});

add_task(async function nonTypedVisits_noAutofill_hostSchemeAndPortVariants() {
  await PlacesTestUtils.addVisits([
    {
      uri: "http://example.com/",
    },
    {
      uri: "https://example.com/",
    },
    {
      uri: "http://www.example.com/",
    },
    {
      uri: "https://www.example.com/",
    },
    {
      uri: "http://www.example.com:4000/",
    },
    {
      uri: "https://www.example.com:4000/",
    },
  ]);

  await PlacesFrecencyRecalculator.recalculateAnyOutdatedFrecencies();

  let context = createContext("ex", { isPrivate: false });
  await check_results({
    context,
    matches: [
      makeSearchResult(context, {
        engineName: "Suggestions",
        heuristic: true,
      }),
      makeVisitResult(context, {
        uri: "https://www.example.com:4000/",
        title: "test visit for https://www.example.com:4000/",
      }),
      makeVisitResult(context, {
        uri: "https://www.example.com/",
        title: "test visit for https://www.example.com/",
      }),
      makeVisitResult(context, {
        uri: "https://example.com/",
        title: "test visit for https://example.com/",
      }),
    ],
  });

  await cleanupPlaces();
});


add_task(async function singleTypedVisit_autofills() {
  await PlacesTestUtils.addVisits([
    {
      uri: "http://example.com/",
      transition: PlacesUtils.history.TRANSITION_TYPED,
    },
  ]);

  await PlacesFrecencyRecalculator.recalculateAnyOutdatedFrecencies();

  let context = createContext("ex", { isPrivate: false });
  await check_results({
    context,
    autofilled: "example.com/",
    completed: "http://example.com/",
    matches: [
      makeVisitResult(context, {
        uri: "http://example.com/",
        title: "test visit for http://example.com/",
        heuristic: true,
      }),
    ],
  });

  await cleanupPlaces();
});


add_task(async function removeTypedVisit_stopsAutofill() {
  await PlacesTestUtils.addVisits([
    {
      uri: "http://example.com/link",
      transition: PlacesUtils.history.TRANSITION_LINK,
    },
    {
      uri: "http://example.com/typed",
      transition: PlacesUtils.history.TRANSITION_TYPED,
    },
  ]);

  await PlacesFrecencyRecalculator.recalculateAnyOutdatedFrecencies();

  let context = createContext("ex", { isPrivate: false });
  await check_results({
    context,
    autofilled: "example.com/",
    completed: "http://example.com/",
    matches: [
      makeVisitResult(context, {
        uri: "http://example.com/",
        title: "example.com",
        heuristic: true,
      }),
      makeVisitResult(context, {
        uri: "http://example.com/typed",
        title: "test visit for http://example.com/typed",
      }),
      makeVisitResult(context, {
        uri: "http://example.com/link",
        title: "test visit for http://example.com/link",
      }),
    ],
  });

  await PlacesUtils.history.remove("http://example.com/typed");
  await PlacesFrecencyRecalculator.recalculateAnyOutdatedFrecencies();

  await check_results({
    context,
    matches: [
      makeSearchResult(context, {
        engineName: "Suggestions",
        heuristic: true,
      }),
      makeVisitResult(context, {
        uri: "http://example.com/link",
        title: "test visit for http://example.com/link",
      }),
    ],
  });

  await cleanupPlaces();
});



add_task(async function sameDayTypedVisits_countAsOne() {
  await PlacesTestUtils.addVisits([
    {
      uri: "http://example.com/1",
      transition: PlacesUtils.history.TRANSITION_TYPED,
    },
    {
      uri: "http://example.com/2",
      transition: PlacesUtils.history.TRANSITION_TYPED,
    },
    {
      uri: "http://example.com/3",
      transition: PlacesUtils.history.TRANSITION_TYPED,
    },
    {
      uri: "http://other.com/",
      transition: PlacesUtils.history.TRANSITION_TYPED,
    },
  ]);

  await PlacesFrecencyRecalculator.recalculateAnyOutdatedFrecencies();

  let exampleFrecency = await getOriginFrecency("http://", "example.com");
  let otherFrecency = await getOriginFrecency("http://", "other.com");

  Assert.equal(
    exampleFrecency,
    otherFrecency,
    "Same day typed visits should not multiply frecency."
  );

  await cleanupPlaces();
});



add_task(async function differentDayTypedVisits_higherFrecency() {
  await PlacesTestUtils.addVisits([
    {
      uri: "http://example1.com/",
      transition: PlacesUtils.history.TRANSITION_TYPED,
      visitDate: daysAgo(0),
    },
    {
      uri: "http://example1.com/",
      transition: PlacesUtils.history.TRANSITION_TYPED,
      visitDate: daysAgo(1),
    },
    {
      uri: "http://example2.com/",
      transition: PlacesUtils.history.TRANSITION_TYPED,
    },
  ]);

  await PlacesFrecencyRecalculator.recalculateAnyOutdatedFrecencies();

  let multiDayFrecency = await getOriginFrecency("http://", "example1.com");
  let singleDayFrecency = await getOriginFrecency("http://", "example2.com");

  Assert.greater(
    multiDayFrecency,
    singleDayFrecency,
    "Multiple typed days should result in a higher frecency."
  );

  let context = createContext("ex", { isPrivate: false });
  await check_results({
    context,
    autofilled: "example1.com/",
    completed: "http://example1.com/",
    matches: [
      makeVisitResult(context, {
        uri: "http://example1.com/",
        title: "test visit for http://example1.com/",
        heuristic: true,
      }),
      makeVisitResult(context, {
        uri: "http://example2.com/",
        title: "test visit for http://example2.com/",
      }),
    ],
  });

  await cleanupPlaces();
});



add_task(async function httpsPreferredOverHttp() {
  await PlacesTestUtils.addVisits([
    {
      uri: "http://example.com/",
      transition: PlacesUtils.history.TRANSITION_TYPED,
    },
    {
      uri: "https://example.com/path",
    },
  ]);

  await PlacesFrecencyRecalculator.recalculateAnyOutdatedFrecencies();

  let context = createContext("ex", { isPrivate: false });
  await check_results({
    context,
    autofilled: "example.com/",
    completed: "https://example.com/",
    matches: [
      makeVisitResult(context, {
        uri: "https://example.com/",
        
        title: "test visit for http://example.com/",
        heuristic: true,
      }),
      makeVisitResult(context, {
        uri: "https://example.com/path",
        title: "test visit for https://example.com/path",
      }),
    ],
  });

  await cleanupPlaces();
});

add_task(async function wwwTyped_nonWwwNonTyped() {
  await PlacesTestUtils.addVisits([
    {
      uri: "http://www.example.com/",
      transition: PlacesUtils.history.TRANSITION_TYPED,
    },
    {
      uri: "http://example.com/link",
      transition: PlacesUtils.history.TRANSITION_LINK,
    },
  ]);

  await PlacesFrecencyRecalculator.recalculateAnyOutdatedFrecencies();

  let context = createContext("ex", { isPrivate: false });
  await check_results({
    context,
    autofilled: "example.com/",
    completed: "http://www.example.com/",
    matches: [
      makeVisitResult(context, {
        uri: "http://www.example.com/",
        title: "test visit for http://www.example.com/",
        heuristic: true,
      }),
      makeVisitResult(context, {
        uri: "http://example.com/link",
        title: "test visit for http://example.com/link",
      }),
    ],
  });

  await cleanupPlaces();
});




add_task(async function prefixCombinedForThreshold() {
  for (let i = 0; i < 3; ++i) {
    
    await PlacesTestUtils.addVisits([
      {
        uri: "http://abc.com/",
        transition: PlacesUtils.history.TRANSITION_TYPED,
        visitDate: daysAgo(i),
      },
      {
        uri: "https://def.com/",
        transition: PlacesUtils.history.TRANSITION_TYPED,
        visitDate: daysAgo(i),
      },
      {
        uri: "https://ghi.com/",
        transition: PlacesUtils.history.TRANSITION_TYPED,
        visitDate: daysAgo(i),
      },
    ]);
  }

  for (let i = 0; i < 2; ++i) {
    await PlacesTestUtils.addVisits([
      {
        uri: "https://example.com/",
        transition: PlacesUtils.history.TRANSITION_TYPED,
        visitDate: daysAgo(i),
      },
      {
        uri: "http://example.com/",
        transition: PlacesUtils.history.TRANSITION_TYPED,
        visitDate: daysAgo(i),
      },
    ]);
  }
  await PlacesFrecencyRecalculator.recalculateAnyOutdatedFrecencies();

  let originFrecency = await getOriginFrecency("https://", "example.com");
  let threshold = await getOriginAutofillThreshold();
  Assert.less(
    originFrecency,
    threshold,
    "https://example.com should be less than the origin frecency threshold."
  );

  originFrecency = await getOriginFrecency("http://", "example.com");
  threshold = await getOriginAutofillThreshold();
  Assert.less(
    originFrecency,
    threshold,
    "http://example.com should be less than the origin frecency threshold."
  );

  let context = createContext("ex", { isPrivate: false });
  await check_results({
    context,
    autofilled: "example.com/",
    completed: "https://example.com/",
    matches: [
      makeVisitResult(context, {
        uri: "https://example.com/",
        title: "test visit for https://example.com/",
        heuristic: true,
      }),
    ],
  });

  await cleanupPlaces();
});




add_task(async function mixedTypedAndNonTyped() {
  
  let nonTypedVisits = [];
  for (let i = 0; i < 200; ++i) {
    nonTypedVisits.push({ url: "https://clickonly.com/1" });
  }
  await PlacesTestUtils.addVisits(nonTypedVisits);
  await PlacesTestUtils.addVisits({
    url: "http://typedonly.com/site",
    transition: PlacesUtils.history.TRANSITION_TYPED,
  });
  await PlacesFrecencyRecalculator.recalculateAnyOutdatedFrecencies();

  let context = createContext("ty", { isPrivate: false });
  await check_results({
    context,
    autofilled: "typedonly.com/",
    completed: "http://typedonly.com/",
    matches: [
      makeVisitResult(context, {
        uri: "http://typedonly.com/",
        title: "typedonly.com",
        heuristic: true,
      }),
      makeVisitResult(context, {
        uri: "http://typedonly.com/site",
        title: "test visit for http://typedonly.com/site",
      }),
    ],
  });

  
  await PlacesTestUtils.addVisits(["https://typedonly.com/foo/bar"]);
  await PlacesFrecencyRecalculator.recalculateAnyOutdatedFrecencies();

  await check_results({
    context,
    autofilled: "typedonly.com/",
    completed: "https://typedonly.com/",
    matches: [
      makeVisitResult(context, {
        uri: "https://typedonly.com/",
        title: "https://typedonly.com",
        heuristic: true,
      }),
      makeVisitResult(context, {
        uri: "http://typedonly.com/site",
        title: "test visit for http://typedonly.com/site",
      }),
      makeVisitResult(context, {
        uri: "https://typedonly.com/foo/bar",
        title: "test visit for https://typedonly.com/foo/bar",
      }),
    ],
  });

  
  context = createContext("clickonly", { isPrivate: false });
  await check_results({
    context,
    matches: [
      makeSearchResult(context, {
        engineName: "Suggestions",
        heuristic: true,
      }),
      makeVisitResult(context, {
        uri: "https://clickonly.com/1",
        title: "test visit for https://clickonly.com/1",
      }),
    ],
  });

  await cleanupPlaces();
});


add_task(async function httpBookmark_httpsNonBookmarkLink() {
  await PlacesTestUtils.addBookmarkWithDetails({
    uri: "http://example.com/path",
  });
  await PlacesTestUtils.addVisits([
    {
      uri: "https://example.com/login",
      transition: PlacesUtils.history.TRANSITION_TYPED,
    },
  ]);
  await PlacesFrecencyRecalculator.recalculateAnyOutdatedFrecencies();

  let context = createContext("ex", { isPrivate: false });
  await check_results({
    context,
    autofilled: "example.com/",
    completed: "https://example.com/",
    matches: [
      makeVisitResult(context, {
        uri: "https://example.com/",
        title: "https://example.com",
        heuristic: true,
      }),
      makeVisitResult(context, {
        uri: "https://example.com/login",
        title: "test visit for https://example.com/login",
      }),
      makeBookmarkResult(context, {
        uri: "http://example.com/path",
        title: "A bookmark",
      }),
    ],
  });

  await cleanupPlaces();
});


add_task(async function httpsBookmark_httpNonBookmarkLink() {
  await PlacesTestUtils.addBookmarkWithDetails({
    uri: "https://example.com/login",
  });
  await PlacesTestUtils.addVisits([
    {
      uri: "http://example.com/path",
      transition: PlacesUtils.history.TRANSITION_TYPED,
    },
  ]);
  await PlacesFrecencyRecalculator.recalculateAnyOutdatedFrecencies();

  let context = createContext("ex", { isPrivate: false });
  await check_results({
    context,
    autofilled: "example.com/",
    completed: "https://example.com/",
    matches: [
      makeVisitResult(context, {
        uri: "https://example.com/",
        title: "https://example.com",
        heuristic: true,
      }),
      makeVisitResult(context, {
        uri: "http://example.com/path",
        title: "test visit for http://example.com/path",
      }),
      makeBookmarkResult(context, {
        uri: "https://example.com/login",
        title: "A bookmark",
      }),
    ],
  });

  await cleanupPlaces();
});



add_task(async function bookmarksCount() {
  await PlacesTestUtils.addBookmarkWithDetails({
    uri: "https://example1.com/1",
  });
  await PlacesTestUtils.addBookmarkWithDetails({
    uri: "https://example1.com/2",
  });

  await PlacesTestUtils.addBookmarkWithDetails({
    uri: "https://example2.com/1",
  });

  await PlacesTestUtils.addVisits([
    {
      uri: "https://example1.com/1",
      transition: PlacesUtils.history.TRANSITION_TYPED,
    },
    {
      uri: "https://example2.com/1",
      transition: PlacesUtils.history.TRANSITION_TYPED,
    },
  ]);
  await PlacesFrecencyRecalculator.recalculateAnyOutdatedFrecencies();

  let context = createContext("ex", { isPrivate: false });
  await check_results({
    context,
    autofilled: "example1.com/",
    completed: "https://example1.com/",
    matches: [
      makeVisitResult(context, {
        uri: "https://example1.com/",
        title: "https://example1.com",
        heuristic: true,
      }),
      makeBookmarkResult(context, {
        uri: "https://example2.com/1",
        title: "A bookmark",
      }),
      makeBookmarkResult(context, {
        uri: "https://example1.com/2",
        title: "A bookmark",
      }),
      makeBookmarkResult(context, {
        uri: "https://example1.com/1",
        title: "A bookmark",
      }),
    ],
  });

  await cleanupPlaces();
});
