






"use strict";

ChromeUtils.defineESModuleGetters(this, {
  AppConstants: "resource://gre/modules/AppConstants.sys.mjs",
  Preferences: "resource://gre/modules/Preferences.sys.mjs",
  TelemetryReportingPolicy:
    "resource://gre/modules/TelemetryReportingPolicy.sys.mjs",
});

const { SUGGEST_TOU_TIMESTAMP } = QuickSuggest;

const EN_LOCALES = ["en-CA", "en-GB", "en-US", "en-ZA"];


const EXPECTED_PREFS_SUGGEST_DISABLED = {
  "quicksuggest.enabled": false,
  "quicksuggest.online.available": false,
  "quicksuggest.online.enabled": true,
  "quicksuggest.settingsUi": QuickSuggest.SETTINGS_UI.NONE,
  "suggest.quicksuggest.all": false,
  "suggest.quicksuggest.sponsored": false,
  "addons.featureGate": false,
  "amp.featureGate": false,
  "importantDates.featureGate": false,
  "mdn.featureGate": false,
  "weather.featureGate": false,
  "wikipedia.featureGate": false,
  "yelp.featureGate": false,
};



const EXPECTED_PREFS_EU_NATIVE = {
  ...EXPECTED_PREFS_SUGGEST_DISABLED,
  "quicksuggest.enabled": true,
  "quicksuggest.settingsUi": QuickSuggest.SETTINGS_UI.OFFLINE_ONLY,
  "suggest.quicksuggest.all": true,
  "suggest.quicksuggest.sponsored": true,
  "importantDates.featureGate": true,
  "weather.featureGate": true,
};



const EXPECTED_PREFS_EU_EN = {
  ...EXPECTED_PREFS_SUGGEST_DISABLED,
  "quicksuggest.enabled": true,
  "importantDates.featureGate": true,
};




const EXPECTED_PREFS_BASE_EN_NATIVE = {
  ...EXPECTED_PREFS_SUGGEST_DISABLED,
  "quicksuggest.enabled": true,
  "quicksuggest.settingsUi": QuickSuggest.SETTINGS_UI.OFFLINE_ONLY,
  "suggest.quicksuggest.all": true,
  "suggest.quicksuggest.sponsored": true,
  "amp.featureGate": true,
  "importantDates.featureGate": true,
  "weather.featureGate": true,
  "wikipedia.featureGate": true,
};


const EXPECTED_PREFS_BY_LOCALE_BY_REGION = {
  DE: {
    de: EXPECTED_PREFS_EU_NATIVE,
    ...Object.fromEntries(
      EN_LOCALES.map(locale => [locale, EXPECTED_PREFS_EU_EN])
    ),
  },
  FR: {
    fr: EXPECTED_PREFS_EU_NATIVE,
    ...Object.fromEntries(
      EN_LOCALES.map(locale => [locale, EXPECTED_PREFS_EU_EN])
    ),
  },
  GB: Object.fromEntries(
    EN_LOCALES.map(locale => [locale, EXPECTED_PREFS_BASE_EN_NATIVE])
  ),
  IT: {
    it: EXPECTED_PREFS_EU_NATIVE,
    ...Object.fromEntries(
      EN_LOCALES.map(locale => [locale, EXPECTED_PREFS_EU_EN])
    ),
  },
  US: Object.fromEntries(
    EN_LOCALES.map(locale => [
      locale,
      {
        ...EXPECTED_PREFS_BASE_EN_NATIVE,
        "addons.featureGate": true,
        "mdn.featureGate": true,
        "yelp.featureGate": true,
      },
    ])
  ),
};

add_setup(async () => {
  await UrlbarTestUtils.initNimbusFeature();
});

add_task(async function primary() {
  let tests = [
    
    { region: "DE", locale: "de" },
    { region: "DE", locale: "en-GB" },
    { region: "DE", locale: "en-US" },

    { region: "FR", locale: "fr" },
    { region: "FR", locale: "en-GB" },
    { region: "FR", locale: "en-US" },

    { region: "GB", locale: "en-US" },
    { region: "GB", locale: "en-CA" },
    { region: "GB", locale: "en-GB" },

    { region: "IT", locale: "it" },
    { region: "IT", locale: "en-GB" },
    { region: "IT", locale: "en-US" },

    { region: "US", locale: "en-US" },
    { region: "US", locale: "en-CA" },
    { region: "US", locale: "en-GB" },

    
    { region: "CA", locale: "en-US" },
    { region: "CA", locale: "en-CA" },
    { region: "GB", locale: "de" },
    { region: "US", locale: "de" },
  ];

  for (let { locale, region } of tests) {
    await doPrimaryTest({ locale, region });
  }
});












async function doPrimaryTest({ locale, region }) {
  let expectedPrefs =
    EXPECTED_PREFS_BY_LOCALE_BY_REGION[region]?.[locale] ??
    EXPECTED_PREFS_SUGGEST_DISABLED;

  let defaultBranch = new Preferences({
    branch: "browser.urlbar.",
    defaultBranch: true,
  });
  let userBranch = new Preferences({
    branch: "browser.urlbar.",
    defaultBranch: false,
  });

  
  let originalDefaults = {};
  for (let name of Object.keys(expectedPrefs)) {
    userBranch.reset(name);
    originalDefaults[name] = defaultBranch.get(name);
  }

  
  
  
  userBranch.reset("quicksuggest.migrationVersion");

  
  await QuickSuggestTestUtils.withRegionAndLocale({
    region,
    locale,
    callback: async () => {
      for (let [name, value] of Object.entries(expectedPrefs)) {
        
        Assert.strictEqual(
          defaultBranch.get(name),
          value,
          `Default pref value for ${name}, locale ${locale}, region ${region}`
        );

        
        
        
        UrlbarPrefs.get(
          name,
          value,
          `UrlbarPrefs.get() value for ${name}, locale ${locale}, region ${region}`
        );

        
        Assert.ok(
          !userBranch.isSet(name),
          "Pref should not be set on the user branch: " + name
        );
      }
    },
  });

  
  for (let [name, originalDefault] of Object.entries(originalDefaults)) {
    if (originalDefault === undefined) {
      Services.prefs.deleteBranch("browser.urlbar." + name);
    } else {
      defaultBranch.set(name, originalDefault);
    }
  }
}




add_task(async function onlineAvailable_init() {
  
  Assert.equal(
    typeof QuickSuggest._isNightlyBuild,
    "boolean",
    "Sanity check: QuickSuggest._isNightlyBuild should be a boolean"
  );
  Assert.equal(
    QuickSuggest._isNightlyBuild,
    AppConstants.NIGHTLY_BUILD,
    "Sanity check: QuickSuggest._isNightlyBuild should match AppConstants"
  );

  let tests = [
    
    {
      isNightlyBuild: false,
      touAcceptedDate: 0,
      expected: {
        "quicksuggest.online.available": false,
        "quicksuggest.settingsUi": QuickSuggest.SETTINGS_UI.OFFLINE_ONLY,
        "flightStatus.featureGate": false,
        "market.featureGate": false,
        "sports.featureGate": false,
      },
    },
    {
      isNightlyBuild: false,
      touAcceptedDate: SUGGEST_TOU_TIMESTAMP - 1,
      expected: {
        "quicksuggest.online.available": false,
        "quicksuggest.settingsUi": QuickSuggest.SETTINGS_UI.OFFLINE_ONLY,
        "flightStatus.featureGate": false,
        "market.featureGate": false,
        "sports.featureGate": false,
      },
    },
    {
      isNightlyBuild: false,
      touAcceptedDate: SUGGEST_TOU_TIMESTAMP,
      expected: {
        "quicksuggest.online.available": false,
        "quicksuggest.settingsUi": QuickSuggest.SETTINGS_UI.OFFLINE_ONLY,
        "flightStatus.featureGate": false,
        "market.featureGate": false,
        "sports.featureGate": false,
      },
    },

    
    {
      isNightlyBuild: true,
      touAcceptedDate: 0,
      expected: {
        "quicksuggest.online.available": false,
        "quicksuggest.settingsUi": QuickSuggest.SETTINGS_UI.OFFLINE_ONLY,
        "flightStatus.featureGate": false,
        "market.featureGate": false,
        "sports.featureGate": false,
      },
    },
    {
      isNightlyBuild: true,
      touAcceptedDate: SUGGEST_TOU_TIMESTAMP - 1,
      expected: {
        "quicksuggest.online.available": false,
        "quicksuggest.settingsUi": QuickSuggest.SETTINGS_UI.OFFLINE_ONLY,
        "flightStatus.featureGate": false,
        "market.featureGate": false,
        "sports.featureGate": false,
      },
    },
    {
      isNightlyBuild: true,
      touAcceptedDate: SUGGEST_TOU_TIMESTAMP,
      expected: {
        "quicksuggest.online.available": true,
        "quicksuggest.settingsUi": QuickSuggest.SETTINGS_UI.FULL,
        "flightStatus.featureGate": true,
        "market.featureGate": true,
        "sports.featureGate": true,
      },
    },

    
    
    {
      region: "JP",
      locale: "ja",
      isNightlyBuild: true,
      touAcceptedDate: SUGGEST_TOU_TIMESTAMP,
      expected: {
        "quicksuggest.online.available": false,
        "quicksuggest.settingsUi": QuickSuggest.SETTINGS_UI.NONE,
        "flightStatus.featureGate": false,
        "market.featureGate": false,
        "sports.featureGate": false,
      },
    },
  ];

  for (let {
    region,
    locale,
    isNightlyBuild,
    touAcceptedDate,
    expected,
  } of tests) {
    await doOnlineAvailableTest({
      region,
      locale,
      isNightlyBuild,
      touAcceptedDate,
      expected,
    });
  }
});




add_task(async function onlineAvailable_onToUAccepted() {
  
  
  await QuickSuggest.init();

  let tests = [
    {
      region: "US",
      locale: "en-US",
      expectedBefore: {
        "quicksuggest.online.available": false,
        "quicksuggest.settingsUi": QuickSuggest.SETTINGS_UI.OFFLINE_ONLY,
        "flightStatus.featureGate": false,
        "market.featureGate": false,
        "sports.featureGate": false,
      },
      expectedAfter: {
        "quicksuggest.online.available": true,
        "quicksuggest.settingsUi": QuickSuggest.SETTINGS_UI.FULL,
        "flightStatus.featureGate": true,
        "market.featureGate": true,
        "sports.featureGate": true,
      },
    },
    
    {
      region: "JP",
      locale: "ja",
      expectedBefore: {
        "quicksuggest.online.available": false,
        "quicksuggest.settingsUi": QuickSuggest.SETTINGS_UI.NONE,
        "flightStatus.featureGate": false,
        "market.featureGate": false,
        "sports.featureGate": false,
      },
      
      expectedAfter: {
        "quicksuggest.online.available": false,
        "quicksuggest.settingsUi": QuickSuggest.SETTINGS_UI.NONE,
        "flightStatus.featureGate": false,
        "market.featureGate": false,
        "sports.featureGate": false,
      },
    },
  ];

  for (let { region, locale, expectedBefore, expectedAfter } of tests) {
    await doOnlineAvailableTest({
      region,
      locale,
      isNightlyBuild: true,
      touAcceptedDate: 0,
      expected: expectedBefore,
      callback: async () => {
        info("Setting ToU accepted date");
        Services.prefs.setCharPref(
          TelemetryReportingPolicy.TOU_ACCEPTED_DATE_PREF,
          SUGGEST_TOU_TIMESTAMP
        );
        for (let [name, value] of Object.entries(expectedAfter)) {
          Assert.equal(
            UrlbarPrefs.get(name),
            value,
            "Pref should have expected value after accepting ToU: " + name
          );
        }
      },
    });
  }
});

async function doOnlineAvailableTest({
  isNightlyBuild,
  touAcceptedDate,
  expected,
  region = "US",
  locale = "en-US",
  callback = null,
}) {
  info(
    "Doing online-available test: " +
      JSON.stringify({
        region,
        locale,
        isNightlyBuild,
        touAcceptedDate,
        expected,
      })
  );

  
  let sandbox = sinon.createSandbox();
  sandbox.stub(QuickSuggest, "_isNightlyBuild").value(isNightlyBuild);

  
  Services.prefs.setCharPref(
    TelemetryReportingPolicy.TOU_ACCEPTED_DATE_PREF,
    touAcceptedDate
  );

  await QuickSuggestTestUtils.withRegionAndLocale({
    region,
    locale,
    callback: async () => {
      for (let [name, value] of Object.entries(expected)) {
        Assert.equal(
          UrlbarPrefs.get(name),
          value,
          "Pref should have expected value: " + name
        );
      }
      await callback?.();
    },
  });

  sandbox.restore();
  Services.prefs.clearUserPref(TelemetryReportingPolicy.TOU_ACCEPTED_DATE_PREF);
}
