


"use strict";





const TEST_URL = "data:text/html,a test page";

add_setup(async function () {
  
  await SearchTestUtils.updateRemoteSettingsConfig([{ identifier: "engine" }]);

  CustomizableUI.addWidgetToArea("home-button", "nav-bar");
  registerCleanupFunction(() => {
    CustomizableUI.removeWidgetFromArea("home-button");
    Services.prefs.clearUserPref("browser.engagement.home-button.has-removed");
  });
});









function simulateURLBarDrop(content) {
  EventUtils.synthesizeDrop(
    document.getElementById("home-button"), 
    gURLBar.inputField, 
    [[content]], 
    "copy",
    window
  );
}

add_task(async function checkDragURL() {
  await BrowserTestUtils.withNewTab(TEST_URL, async browser => {
    info("Check dragging a normal url to the urlbar");
    const DRAG_URL = "https://www.example.com/";
    simulateURLBarDrop({ type: "text/plain", data: DRAG_URL });

    
    
    Assert.equal(
      gURLBar.value,
      TEST_URL,
      "URL bar value should not have changed"
    );
    Assert.equal(
      gBrowser.selectedBrowser.userTypedValue,
      null,
      "Stored URL bar value should not have changed"
    );

    await BrowserTestUtils.browserLoaded(browser, false, DRAG_URL);
    Assert.equal(
      gURLBar.untrimmedValue,
      DRAG_URL,
      "URL bar value changes after load"
    );
  });
});

add_task(async function checkDragForbiddenURL() {
  await BrowserTestUtils.withNewTab(TEST_URL, function () {
    
    
    
    for (let url of [
      "chrome://browser/content/aboutDialog.xhtml",
      "file:///",
      "javascript:",
      "javascript:void(0)",
      "java\r\ns\ncript:void(0)",
      " javascript:void(0)",
      "\u00A0java\nscript:void(0)",
      "javascript:document.domain",
      "javascript:javascript:alert('hi!')",
    ]) {
      info(`Check dragging "${url}" to the URL bar`);
      simulateURLBarDrop({ type: "text/plain", data: url });
      Assert.notEqual(
        gURLBar.value,
        url,
        `Shouldn't be allowed to drop ${url} on URL bar`
      );
    }
  });
});

add_task(async function checkDragText() {
  await BrowserTestUtils.withNewTab(TEST_URL, async browser => {
    info("Check dragging multi word text to the urlbar");
    const TEXT = "Firefox is awesome";
    const TEXT_URL = "https://www.example.com/search?q=Firefox+is+awesome";
    let promiseLoad = BrowserTestUtils.browserLoaded(browser, false, TEXT_URL);
    simulateURLBarDrop({ type: "text/plain", data: TEXT });
    await promiseLoad;

    info("Check dragging single word text to the urlbar");
    const WORD = "Firefox";
    const WORD_URL = "https://www.example.com/search?q=Firefox";
    promiseLoad = BrowserTestUtils.browserLoaded(browser, false, WORD_URL);
    simulateURLBarDrop({ type: "text/plain", data: WORD });
    await promiseLoad;
  });
});
