


"use strict";









function serveHTML(html) {
  const { HttpServer } = ChromeUtils.importESModule(
    "resource://testing-common/httpd.sys.mjs"
  );

  const server = new HttpServer();

  server.registerPathHandler("/test-page.html", (_request, response) => {
    response.setHeader("Content-Type", "text/html");
    response.write(html);
  });

  server.start(-1);

  const { primaryHost, primaryPort } = server.identity;
  
  const url = `http://${primaryHost}:${primaryPort}/test-page.html`;

  return {
    url,
    server,
  };
}











async function setupGetPageContentTests(html) {
  const { GetPageContent } = ChromeUtils.importESModule(
    "moz-src:///browser/components/aiwindow/models/Tools.sys.mjs"
  );

  const { url, server } = serveHTML(html);

  const tab = await BrowserTestUtils.openNewForegroundTab(
    gBrowser,
    url,
    true 
  );

  const url_list = [url];

  return {
    url_list,
    GetPageContent,
    async cleanup() {
      info("Cleaning up test");
      BrowserTestUtils.removeTab(tab);
      await new Promise(resolve => server.stop(resolve));
    },
  };
}
