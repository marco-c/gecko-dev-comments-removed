




package org.mozilla.geckoview;

import androidx.annotation.AnyThread;
import androidx.annotation.NonNull;


@ExperimentalGeckoViewApi
public class PageExtractionController {

  





  @ExperimentalGeckoViewApi
  public static class SessionPageExtractor {

    
    private static final String GET_TEXT_CONTENT_EVENT = "GeckoView:PageExtractor:GetTextContent";

    private static final String GET_TEXT_CONTENT_RESULT_KEY = "text";

    private final GeckoSession mSession;

    




    public SessionPageExtractor(final GeckoSession session) {
      mSession = session;
    }

    





    @AnyThread
    public @NonNull GeckoResult<String> getPageContent() {
      return mSession
          .getEventDispatcher()
          .queryBundle(GET_TEXT_CONTENT_EVENT)
          .then(
              result -> {
                if (result == null)
                  return GeckoResult.fromException(
                      new PageExtractionException(PageExtractionException.ERROR_NULL_RESULT));

                final String textContent = result.getString(GET_TEXT_CONTENT_RESULT_KEY);
                if (textContent == null)
                  return GeckoResult.fromException(
                      new PageExtractionException(PageExtractionException.ERROR_MALFORMED_RESULT));

                return GeckoResult.fromValue(textContent);
              },
              exception ->
                  GeckoResult.fromException(
                      new PageExtractionException(
                          PageExtractionException.ERROR_UNKNOWN, exception)));
    }
  }

  
  public static class PageExtractionException extends Exception {

    
    public static final String ERROR_NULL_RESULT = "NULL_RESULT";

    
    public static final String ERROR_MALFORMED_RESULT = "MALFORMED_RESULT";

    



    public static final String ERROR_UNKNOWN = "UNKNOWN_ERROR";

    



    @NonNull public final String errorType;

    





    public PageExtractionException(@NonNull final String errorType) {
      super("Unable to extract page content: " + errorType);
      this.errorType = errorType;
    }

    






    public PageExtractionException(@NonNull final String errorType, final Throwable cause) {
      super("Unable to extract page content: " + errorType, cause);
      this.errorType = errorType;
    }
  }
}
