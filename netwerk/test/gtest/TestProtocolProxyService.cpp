#include "gtest/gtest.h"

#include "nsCOMPtr.h"
#include "nsNetCID.h"
#include "nsString.h"
#include "nsComponentManagerUtils.h"
#include "../../base/nsProtocolProxyService.h"
#include "nsServiceManagerUtils.h"
#include "mozilla/Preferences.h"
#include "nsNetUtil.h"
#include "prenv.h"
#include "nsISystemProxySettings.h"

namespace mozilla {
namespace net {

TEST(TestProtocolProxyService, LoadHostFilters)
{
  nsCOMPtr<nsIProtocolProxyService2> ps =
      do_GetService(NS_PROTOCOLPROXYSERVICE_CID);
  ASSERT_TRUE(ps);
  mozilla::net::nsProtocolProxyService* pps =
      static_cast<mozilla::net::nsProtocolProxyService*>(ps.get());

  nsCOMPtr<nsIURI> url;
  nsAutoCString spec;

  auto CheckLoopbackURLs = [&](bool expected) {
    
    spec = "http://127.0.0.1";
    ASSERT_EQ(NS_NewURI(getter_AddRefs(url), spec), NS_OK);
    ASSERT_EQ(pps->CanUseProxy(url, 80), expected);
    spec = "http://[::1]";
    ASSERT_EQ(NS_NewURI(getter_AddRefs(url), spec), NS_OK);
    ASSERT_EQ(pps->CanUseProxy(url, 80), expected);
    spec = "http://localhost";
    ASSERT_EQ(NS_NewURI(getter_AddRefs(url), spec), NS_OK);
    ASSERT_EQ(pps->CanUseProxy(url, 80), expected);
  };

  auto CheckURLs = [&](bool expected) {
    spec = "http://example.com";
    ASSERT_EQ(NS_NewURI(getter_AddRefs(url), spec), NS_OK);
    ASSERT_EQ(pps->CanUseProxy(url, 80), expected);

    spec = "https://10.2.3.4";
    ASSERT_EQ(NS_NewURI(getter_AddRefs(url), spec), NS_OK);
    ASSERT_EQ(pps->CanUseProxy(url, 443), expected);

    spec = "http://1.2.3.4";
    ASSERT_EQ(NS_NewURI(getter_AddRefs(url), spec), NS_OK);
    ASSERT_EQ(pps->CanUseProxy(url, 80), expected);

    spec = "http://1.2.3.4:8080";
    ASSERT_EQ(NS_NewURI(getter_AddRefs(url), spec), NS_OK);
    ASSERT_EQ(pps->CanUseProxy(url, 80), expected);

    spec = "http://[2001::1]";
    ASSERT_EQ(NS_NewURI(getter_AddRefs(url), spec), NS_OK);
    ASSERT_EQ(pps->CanUseProxy(url, 80), expected);

    spec = "http://2.3.4.5:7777";
    ASSERT_EQ(NS_NewURI(getter_AddRefs(url), spec), NS_OK);
    ASSERT_EQ(pps->CanUseProxy(url, 80), expected);

    spec = "http://[abcd::2]:123";
    ASSERT_EQ(NS_NewURI(getter_AddRefs(url), spec), NS_OK);
    ASSERT_EQ(pps->CanUseProxy(url, 80), expected);

    spec = "http://bla.test.com";
    ASSERT_EQ(NS_NewURI(getter_AddRefs(url), spec), NS_OK);
    ASSERT_EQ(pps->CanUseProxy(url, 80), expected);
  };

  auto CheckPortDomain = [&](bool expected) {
    spec = "http://blabla.com:10";
    ASSERT_EQ(NS_NewURI(getter_AddRefs(url), spec), NS_OK);
    ASSERT_EQ(pps->CanUseProxy(url, 80), expected);
  };

  auto CheckLocalDomain = [&](bool expected) {
    spec = "http://test";
    ASSERT_EQ(NS_NewURI(getter_AddRefs(url), spec), NS_OK);
    ASSERT_EQ(pps->CanUseProxy(url, 80), expected);
  };

  

  nsAutoCString filter;

  
  printf("Testing empty filter: %s\n", filter.get());
  pps->LoadHostFilters(filter);

  CheckLoopbackURLs(false);
  CheckLocalDomain(true);
  CheckURLs(true);
  CheckPortDomain(true);

  

  filter =
      "example.com, 1.2.3.4/16, [2001::1], 10.0.0.0/8, 2.3.0.0/16:7777, "
      "[abcd::1]/64:123, *.test.com";
  printf("Testing filter: %s\n", filter.get());
  pps->LoadHostFilters(filter);

  CheckLoopbackURLs(false);
  
  CheckURLs(false);
  CheckLocalDomain(true);
  CheckPortDomain(true);

  

  
  
  filter = "<local> blabla.com:10";
  printf("Testing filter: %s\n", filter.get());
  pps->LoadHostFilters(filter);

  CheckLoopbackURLs(false);
  CheckURLs(true);
  CheckLocalDomain(false);
  CheckPortDomain(false);

  
  filter = "a b c abc:1x2, ,, * ** *.* *:10 :20 :40/12 */12:90";
  printf("Testing filter: %s\n", filter.get());
  pps->LoadHostFilters(filter);

  
  filter = "<local>";
  printf("Testing filter: %s\n", filter.get());
  pps->LoadHostFilters(filter);

  CheckLoopbackURLs(false);
  CheckURLs(true);
  CheckLocalDomain(false);
  CheckPortDomain(true);

  
  Preferences::SetBool("network.proxy.allow_hijacking_localhost", true);

  filter = "";
  printf("Testing filter: %s\n", filter.get());
  pps->LoadHostFilters(filter);

  CheckLoopbackURLs(true);
  CheckLocalDomain(true);
  CheckURLs(true);
  CheckPortDomain(true);

  
  filter = "127.0.0.1, [::1], localhost, blabla.com:10";
  printf("Testing filter: %s\n", filter.get());
  pps->LoadHostFilters(filter);

  CheckLoopbackURLs(false);
  CheckLocalDomain(true);
  CheckURLs(true);
  CheckPortDomain(false);
}

#ifndef ANDROID
TEST(TestProtocolProxyService, Proxy_Env_Vars)
{
  nsCOMPtr<nsISystemProxySettings> systemProxy =
      do_GetService(NS_SYSTEMPROXYSETTINGS_CONTRACTID);
  ASSERT_TRUE(systemProxy != nullptr);

  auto CheckProxy = [&](const char* url, const char* expected) {
    nsCOMPtr<nsIURI> uri;
    ASSERT_EQ(NS_NewURI(getter_AddRefs(uri), url), NS_OK);
    nsAutoCString spec, scheme, host;
    int32_t port = -1;
    uri->GetSpec(spec);
    uri->GetScheme(scheme);
    uri->GetHost(host);
    uri->GetPort(&port);

    nsAutoCString result;
    nsresult rv = systemProxy->GetProxyForURI(spec, scheme, host, port, result);
    ASSERT_EQ(rv, NS_OK);
    
    EXPECT_TRUE(result.Find(expected) != kNotFound)
        << "URL: " << url << ", Result: " << result.get()
        << ", Expected: " << expected;
  };

  
  {
    PR_SetEnv("http_proxy=http://127.0.0.1:8080");
    CheckProxy("http://example.com", "PROXY 127.0.0.1:8080");
    PR_SetEnv("http_proxy=");
  }

  
  {
    PR_SetEnv("https_proxy=http://127.0.0.1:8443");
    CheckProxy("https://example.com", "PROXY 127.0.0.1:8443");
    PR_SetEnv("https_proxy=");
  }

  
  {
    PR_SetEnv("all_proxy=http://127.0.0.1:9090");
    CheckProxy("ftp://example.com", "PROXY 127.0.0.1:9090");
    PR_SetEnv("all_proxy=");
  }

  
  {
    PR_SetEnv("http_proxy=http://127.0.0.1:8080");
    PR_SetEnv("no_proxy=example.com,.test.com");

    
    CheckProxy("http://example.com", "DIRECT");
    
    CheckProxy("http://sub.test.com", "DIRECT");
    
    CheckProxy("http://other.com", "PROXY 127.0.0.1:8080");

    PR_SetEnv("http_proxy=");
    PR_SetEnv("no_proxy=");
  }

  
  {
    PR_SetEnv("http_proxy=http://127.0.0.1:8080");
    PR_SetEnv("no_proxy=example.com:8080");

    
    CheckProxy("http://example.com:8080", "DIRECT");
    
    CheckProxy("http://example.com", "PROXY 127.0.0.1:8080");
    
    CheckProxy("http://example.com:9090", "PROXY 127.0.0.1:8080");

    PR_SetEnv("http_proxy=");
    PR_SetEnv("no_proxy=");
  }

  
  {
    PR_SetEnv("http_proxy=http://127.0.0.1:8080");
    PR_SetEnv("https_proxy=http://127.0.0.1:8443");
    PR_SetEnv("no_proxy=exact.com:9443,wildcard.com");

    
    CheckProxy("https://exact.com:9443", "DIRECT");
    
    CheckProxy("https://exact.com", "PROXY 127.0.0.1:8443");
    
    CheckProxy("https://exact.com:8443", "PROXY 127.0.0.1:8443");
    
    CheckProxy("http://wildcard.com", "DIRECT");
    CheckProxy("http://wildcard.com:8080", "DIRECT");
    CheckProxy("https://wildcard.com:443", "DIRECT");

    PR_SetEnv("http_proxy=");
    PR_SetEnv("https_proxy=");
    PR_SetEnv("no_proxy=");
  }

  
  {
    PR_SetEnv("http_proxy=http://127.0.0.1:8080");
    CheckProxy("ws://example.com", "PROXY 127.0.0.1:8080");
    PR_SetEnv("http_proxy=");
  }

  
  {
    PR_SetEnv("https_proxy=http://127.0.0.1:8443");
    CheckProxy("wss://example.com", "PROXY 127.0.0.1:8443");
    PR_SetEnv("https_proxy=");
  }

  
  {
    PR_SetEnv("http_proxy=http://127.0.0.1");
    CheckProxy("http://example.com", "PROXY 127.0.0.1");
    PR_SetEnv("http_proxy=");

    PR_SetEnv("https_proxy=http://127.0.0.1");
    CheckProxy("https://example.com", "PROXY 127.0.0.1");
    PR_SetEnv("https_proxy=");
  }
}
#endif  

}  
}  
