









async function test(context, commands) {
  let rootUrl = "https://www.youtube.com/watch?v=YE7VzlLtp-4";
  let waitTime = 20000;

  if (
    typeof context.options.browsertime !== "undefined" &&
    typeof context.options.browsertime.waitTime !== "undefined"
  ) {
    waitTime = context.options.browsertime.waitTime;
  }

  
  await commands.navigate(rootUrl);

  
  await commands.js.runAndWait(`
    document.cookie =
      'SOCS=CAESEwgDEgk4NTQ5OTI2NTgaAmVuIAEaBgiAlpbLBg; path=/; domain=.youtube.com; Secure; SameSite=None';
  `);

  let cycles = 1;
  for (let cycle = 0; cycle < cycles; cycle++) {
    await commands.measure.start("pageload");
    await commands.navigate(rootUrl);

    
    
    if (
      await commands.js.run(`return document.querySelector("video").paused;`)
    ) {
      throw new Error("Video should be running but it's paused");
    }

    
    
    

    
    const start = await commands.js.run(`return performance.now();`);
    let counter = 1;
    let direction = 0;
    while (
      !(await commands.js.run(`
          return document.querySelector("video").ended;
      `)) &&
      !(await commands.js.run(`
          return document.querySelector("video").paused;
      `)) &&
      (await commands.js.run(`return performance.now();`)) - start < waitTime
    ) {
      
      direction = counter * 1000;
      if (direction > 10000) {
        counter = -1;
      }
      counter++;

      await commands.js.runAndWait(
        `window.scrollTo({ top: ${direction}, behavior: 'smooth' })`
      );
      context.log.info("playing while scrolling...");
    }

    
    const playbackQuality = await commands.js.run(
      `return document.querySelector("video").getVideoPlaybackQuality();`
    );
    await commands.measure.stop();

    commands.measure.result[0].browserScripts.pageinfo.droppedFrames =
      playbackQuality.droppedVideoFrames;
    commands.measure.result[0].browserScripts.pageinfo.decodedFrames =
      playbackQuality.totalVideoFrames;
  }
}

module.exports = {
  test,
  owner: "Network Team",
  component: "netwerk",
  name: "youtube-scroll",
  description: "Measures quality of the video being played.",
};
