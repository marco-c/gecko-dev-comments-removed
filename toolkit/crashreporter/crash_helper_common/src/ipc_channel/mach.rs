



use std::process;

use crate::{
    ipc_channel::IPCChannelError, platform::mach::ReceiveRight, IPCConnector, IPCListener, Pid,
};

pub struct IPCChannel {
    listener: IPCListener,
    client_endpoint: IPCConnector,
    server_endpoint: IPCConnector,
}

impl IPCChannel {
    
    
    
    pub fn new() -> Result<IPCChannel, IPCChannelError> {
        let listener = IPCListener::new(process::id() as Pid)?;
        let client_recv = ReceiveRight::new()?;
        let helper_recv = ReceiveRight::new()?;
        let client_send = helper_recv.insert_send_right()?;
        let helper_send = client_recv.insert_send_right()?;

        let client_endpoint = IPCConnector::from_rights(client_send, client_recv)?;
        let server_endpoint = IPCConnector::from_rights(helper_send, helper_recv)?;

        Ok(IPCChannel {
            listener,
            client_endpoint,
            server_endpoint,
        })
    }

    
    
    pub fn deconstruct(self) -> (IPCListener, IPCConnector, IPCConnector) {
        (self.listener, self.server_endpoint, self.client_endpoint)
    }
}

pub struct IPCClientChannel {
    client_endpoint: IPCConnector,
    server_endpoint: IPCConnector,
}

impl IPCClientChannel {
    
    
    pub fn new() -> Result<IPCClientChannel, IPCChannelError> {
        let client_recv = ReceiveRight::new()?;
        let helper_recv = ReceiveRight::new()?;
        let client_send = helper_recv.insert_send_right()?;
        let helper_send = client_recv.insert_send_right()?;

        let client_endpoint = IPCConnector::from_rights(client_send, client_recv)?;
        let server_endpoint = IPCConnector::from_rights(helper_send, helper_recv)?;

        Ok(IPCClientChannel {
            client_endpoint,
            server_endpoint,
        })
    }

    
    
    pub fn deconstruct(self) -> (IPCConnector, IPCConnector) {
        (self.server_endpoint, self.client_endpoint)
    }
}
