






"use strict";

add_setup(async function () {
  SearchTestUtils.setRemoteSettingsConfig([{ identifier: "unused" }]);

  let data = await readJSONFile(
    do_get_file("settings/v1-migrate-to-webextension.json")
  );

  await promiseSaveSettingsData(data);

  await SearchService.init();

  
  
  
  let oldFunc = SearchService.wrappedJSObject.addEnginesFromExtension;
  SearchService.wrappedJSObject.addEnginesFromExtension = () => {};

  
  await SearchTestUtils.installSearchExtension({
    id: "simple",
    name: "simple search",
    search_url: "https://example.com/",
  });

  SearchService.wrappedJSObject.addEnginesFromExtension = oldFunc;
});

add_task(async function test_migrateLegacyEngineDifferentName() {
  await SearchService.init();

  let engine = SearchService.getEngineByName("simple");
  Assert.ok(engine, "Should have the legacy add-on engine.");

  
  
  await SearchService.setDefault(engine, SearchService.CHANGE_REASON.UNKNOWN);

  engine = SearchService.getEngineByName("simple search");
  Assert.ok(engine, "Should have the WebExtension engine.");

  await SearchService.runBackgroundChecks();

  engine = SearchService.getEngineByName("simple");
  Assert.ok(!engine, "Should have removed the legacy add-on engine");

  engine = SearchService.getEngineByName("simple search");
  Assert.ok(engine, "Should have kept the WebExtension engine.");

  Assert.equal(
    (await SearchService.getDefault()).name,
    engine.name,
    "Should have switched to the WebExtension engine as default."
  );
});
