


const kDefaultEngineName = "engine1";
const kOtherAppProvidedEngineId = "engine2";

add_setup(async function () {
  useHttpServer();
  SearchTestUtils.setRemoteSettingsConfig([
    { identifier: kDefaultEngineName },
    { identifier: kOtherAppProvidedEngineId },
  ]);
  Assert.ok(!SearchService.isInitialized);
  Services.prefs.setBoolPref(
    "browser.search.removeEngineInfobar.enabled",
    false
  );
});

add_task(async function test_defaultEngine() {
  await SearchService.init();
  await SearchTestUtils.installOpenSearchEngine({
    url: `${gHttpURL}/opensearch/generic1.xml`,
  });

  Assert.equal(SearchService.defaultEngine.name, kDefaultEngineName);
});


add_task(async function test_persistAcrossRestarts() {
  
  await SearchService.setDefault(
    SearchService.getEngineByName(kTestEngineName),
    Ci.nsISearchService.CHANGE_REASON_UNKNOWN
  );
  Assert.equal(SearchService.defaultEngine.name, kTestEngineName);
  await promiseAfterSettings();

  
  let metadata = await promiseGlobalMetadata();
  Assert.equal(metadata.defaultEngineIdHash.length, 44);

  
  SearchService.wrappedJSObject.reset();
  await SearchService.init(true);
  Assert.equal(SearchService.defaultEngine.name, kTestEngineName);

  
  SearchService.resetToAppDefaultEngine();
  Assert.equal(SearchService.defaultEngine.name, kDefaultEngineName);
});


add_task(async function test_ignoreInvalidHash() {
  
  await SearchService.setDefault(
    SearchService.getEngineByName(kTestEngineName),
    Ci.nsISearchService.CHANGE_REASON_UNKNOWN
  );
  Assert.equal(SearchService.defaultEngine.name, kTestEngineName);
  await promiseAfterSettings();

  
  let metadata = await promiseGlobalMetadata();
  metadata.defaultEngineIdHash = "invalid";
  await promiseSaveGlobalMetadata(metadata);

  
  SearchService.wrappedJSObject.reset();
  await SearchService.init(true);
  Assert.equal(SearchService.defaultEngine.name, kDefaultEngineName);
});


add_task(async function test_settingToDefault() {
  
  await SearchService.setDefault(
    SearchService.getEngineByName(kTestEngineName),
    Ci.nsISearchService.CHANGE_REASON_UNKNOWN
  );
  Assert.equal(SearchService.defaultEngine.name, kTestEngineName);
  await promiseAfterSettings();

  
  let metadata = await promiseGlobalMetadata();
  let currentEngine = SearchService.getEngineByName(kTestEngineName);
  Assert.equal(metadata.defaultEngineId, currentEngine.id);

  
  await SearchService.setDefault(
    SearchService.getEngineByName(kDefaultEngineName),
    Ci.nsISearchService.CHANGE_REASON_UNKNOWN
  );
  await promiseAfterSettings();

  
  metadata = await promiseGlobalMetadata();
  Assert.equal(metadata.defaultEngineId, "");
});

add_task(async function test_resetToOriginalDefaultEngine() {
  Assert.equal(SearchService.defaultEngine.name, kDefaultEngineName);

  await SearchService.setDefault(
    SearchService.getEngineByName(kTestEngineName),
    Ci.nsISearchService.CHANGE_REASON_UNKNOWN
  );
  Assert.equal(SearchService.defaultEngine.name, kTestEngineName);
  await promiseAfterSettings();

  SearchService.resetToAppDefaultEngine();
  Assert.equal(SearchService.defaultEngine.name, kDefaultEngineName);
  await promiseAfterSettings();
});

add_task(async function test_fallback_kept_after_restart() {
  
  let otherAppProvidedEngine = SearchService.getEngineById(
    kOtherAppProvidedEngineId
  );

  await SearchService.setDefault(
    otherAppProvidedEngine,
    Ci.nsISearchService.CHANGE_REASON_UNKNOWN
  );
  Assert.equal(SearchService.defaultEngine.name, otherAppProvidedEngine.name);
  await promiseAfterSettings();

  
  await SearchService.removeEngine(otherAppProvidedEngine);
  
  
  Assert.ok(otherAppProvidedEngine.hidden);

  
  
  Assert.equal(SearchService.defaultEngine.name, kDefaultEngineName);

  
  
  SearchService.restoreDefaultEngines();
  Assert.ok(!otherAppProvidedEngine.hidden);
  Assert.equal(SearchService.defaultEngine.name, kDefaultEngineName);
  await promiseAfterSettings();

  
  SearchService.wrappedJSObject.reset();
  await SearchService.init(true);
  Assert.equal(SearchService.defaultEngine.name, kDefaultEngineName);
});
