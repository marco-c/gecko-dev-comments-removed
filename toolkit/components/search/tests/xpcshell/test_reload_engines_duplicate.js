










"use strict";

const CONFIG = [
  {
    identifier: "appDefault",
    base: { name: "Application Default" },
  },
  {
    identifier: "notInFR",
    base: { name: "Not In FR" },
    variants: [{ environment: { regions: ["FR"] } }],
  },
];

add_setup(async () => {
  let server = useHttpServer();
  server.registerContentType("sjs", "sjs");

  
  
  
  
  Region._setHomeRegion("US", false);

  SearchTestUtils.setRemoteSettingsConfig(CONFIG);
  await SearchService.init();
});

add_task(async function test_reload_engines_with_duplicate() {
  let engines = await SearchService.getEngines();

  Assert.deepEqual(
    engines.map(e => e.id),
    ["appDefault"],
    "Should have the expected default engines"
  );
  
  
  let engine = await SearchTestUtils.installOpenSearchEngine({
    url: `${gHttpURL}/sjs/engineMaker.sjs?${JSON.stringify({
      baseURL: `${gHttpURL}/data/`,
      name: "Not In FR",
      method: "GET",
    })}`,
  });

  engine.alias = "testEngine";

  let engineId = engine.id;

  Region._setHomeRegion("FR", false);

  await SearchService.wrappedJSObject._maybeReloadEngines();

  Assert.ok(
    !(await SearchService.getEngineById(engineId)),
    "Should not have added the duplicate engine"
  );

  engines = await SearchService.getEngines();

  Assert.deepEqual(
    engines.map(e => e.id),
    ["appDefault", "notInFR"],
    "Should have the expected default engines"
  );

  let enginePref = await SearchService.getEngineByName("Not In FR");

  Assert.equal(
    enginePref.alias,
    "",
    "Should not have copied the alias from the duplicate engine"
  );
});
