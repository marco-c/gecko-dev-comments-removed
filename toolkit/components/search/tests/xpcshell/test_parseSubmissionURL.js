






"use strict";

add_setup(async function () {
  useHttpServer("");
});

add_task(async function test_parseSubmissionURL() {
  let engine1 = await SearchTestUtils.installOpenSearchEngine({
    url: `${gHttpURL}/opensearch/generic1.xml`,
  });
  let engine2 = await SearchTestUtils.installOpenSearchEngine({
    url: `${gHttpURL}/opensearch/fr-domain-iso8859-1.xml`,
  });

  await SearchTestUtils.installSearchExtension({
    name: "bacon_addParam",
    keyword: "bacon_addParam",
    encoding: "windows-1252",
    search_url: "https://www.bacon.test/find",
  });
  await SearchTestUtils.installSearchExtension({
    name: "idn_addParam",
    keyword: "idn_addParam",
    search_url: "https://www.xn--bcher-kva.ch/search",
  });
  let engine3 = SearchService.getEngineByName("bacon_addParam");
  let engine4 = SearchService.getEngineByName("idn_addParam");

  
  
  let engine5 = await SearchTestUtils.installOpenSearchEngine({
    url: `${gHttpURL}/opensearch/generic2.xml`,
  });

  
  await SearchTestUtils.installSearchExtension({
    name: "bacon",
    keyword: "bacon",
    search_url: "https://www.bacon.moz/search?q=",
    search_url_get_params: "",
  });

  await SearchService.setDefault(engine1, SearchService.CHANGE_REASON.UNKNOWN);

  
  for (let engine of await SearchService.getAppProvidedEngines()) {
    await SearchService.removeEngine(engine);
  }

  
  
  
  let url = "https://www.google.com/search?foo=bar&q=caff%C3%A8";
  let result = SearchService.parseSubmissionURL(url);
  Assert.equal(result.engine, engine1);
  Assert.equal(result.terms, "caff\u00E8");

  
  
  
  url = "https://www.google.fr/search?q=caff%E8";
  result = SearchService.parseSubmissionURL(url);
  Assert.equal(result.engine, engine2);
  Assert.equal(result.terms, "caff\u00E8");

  
  
  url = "https://www.google.co.uk/search?q=caff%C3%A8";
  result = SearchService.parseSubmissionURL(url);
  Assert.equal(result.engine, engine1);
  Assert.equal(result.terms, "caff\u00E8");

  
  url = "https://www.bacon.test/find?q=caff%E8";
  result = SearchService.parseSubmissionURL(url);
  Assert.equal(result.engine, engine3);
  Assert.equal(result.terms, "caff\u00E8");

  
  url = "https://www.google.com/search?q=foo+b\u00E4r";
  result = SearchService.parseSubmissionURL(url);
  Assert.equal(result.engine, engine1);
  Assert.equal(result.terms, "foo b\u00E4r");

  
  url = "https://www.b\u00FCcher.ch/search?q=foo+bar";
  result = SearchService.parseSubmissionURL(url);
  Assert.equal(result.engine, engine4);
  Assert.equal(result.terms, "foo bar");

  
  url = "https://www.xn--bcher-kva.ch/search?q=foo+bar";
  result = SearchService.parseSubmissionURL(url);
  Assert.equal(result.engine, engine4);
  Assert.equal(result.terms, "foo bar");

  
  
  Assert.equal(
    SearchService.parseSubmissionURL("https://www.bacon.moz/search?q=").engine,
    null
  );

  
  
  url = "https://duckduckgo.com/?foo=bar&q=caff%C3%A8";
  result = SearchService.parseSubmissionURL(url);
  Assert.equal(result.engine, engine5);
  Assert.equal(result.terms, "caff\u00E8");

  
  
  
  url = "https://duckduckgo.com?foo=bar&q=caff%C3%A8";
  result = SearchService.parseSubmissionURL(url);
  Assert.equal(result.engine, engine5);
  Assert.equal(result.terms, "caff\u00E8");

  
  url = "https://www.google.com/search?q=caff%C3%A8";
  result = SearchService.parseSubmissionURL(url);
  Assert.equal(result.engine, engine1);
  Assert.equal(result.terms, "caff\u00E8");

  
  result = SearchService.parseSubmissionURL(
    "https://www.google.com/search?q=+with++spaces+"
  );
  Assert.equal(result.engine, engine1);
  Assert.equal(result.terms, " with  spaces ");

  
  result = SearchService.parseSubmissionURL(
    "https://www.google.com/search?q=with%26ampersand"
  );
  Assert.equal(result.engine, engine1);
  Assert.equal(result.terms, "with&ampersand");

  
  result = SearchService.parseSubmissionURL(
    "https://www.google.com/SEARCH?q=caps"
  );
  Assert.equal(result.engine, engine1);
  Assert.equal(result.terms, "caps");

  
  url = "https://www.google.com/search?q=";
  result = SearchService.parseSubmissionURL(url);
  Assert.equal(result.engine, engine1);
  Assert.equal(result.terms, "");

  
  result = SearchService.parseSubmissionURL(
    "https://www.google.com/search/?q=test"
  );
  Assert.equal(result.engine, null);
  Assert.equal(result.terms, "");

  
  result = SearchService.parseSubmissionURL(
    "https://www.google.com/search?q2=test"
  );
  Assert.equal(result.engine, null);
  Assert.equal(result.terms, "");

  
  result = SearchService.parseSubmissionURL("file://localhost/search?q=test");
  Assert.equal(result.engine, null);
  Assert.equal(result.terms, "");
});
