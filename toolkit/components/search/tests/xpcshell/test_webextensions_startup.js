






"use strict";

const lazy = {};

ChromeUtils.defineESModuleGetters(lazy, {
  ExtensionTestUtils:
    "resource://testing-common/ExtensionXPCShellUtils.sys.mjs",
});

let extension;

add_setup(async function () {
  let server = useHttpServer();
  server.registerContentType("sjs", "sjs");

  SearchTestUtils.setRemoteSettingsConfig([{ identifier: "unused" }]);
  await SearchTestUtils.initXPCShellAddonManager();
});

add_task(async function test_startup_with_new_addon() {
  
  
  

  
  
  let extensionInfo = {
    useAddonManager: "permanent",
    files: {},
    manifest: SearchTestUtils.createEngineManifest({
      name: "startup",
      search_url: "https://example.com/",
    }),
  };

  extension = lazy.ExtensionTestUtils.loadExtension(extensionInfo);
  await extension.startup();

  let settingsWritten = promiseAfterSettings();
  await SearchService.init();

  await AddonTestUtils.waitForSearchProviderStartup(extension);
  await settingsWritten;

  let engine = await SearchService.getEngineByName("startup");
  Assert.ok(engine, "Should have loaded the engine");
  let submission = engine.getSubmission("foo");
  Assert.equal(
    submission.uri.spec,
    "https://example.com/?q=foo",
    "Should have the expected search url."
  );
});

add_task(async function test_startup_with_existing_addon_from_settings() {
  SearchService.reset();

  let settingsWritten = promiseAfterSettings();
  await SearchService.init();
  await settingsWritten;

  let engine = await SearchService.getEngineByName("startup");
  Assert.ok(engine, "Should have loaded the engine");
  let submission = engine.getSubmission("foo");
  Assert.equal(
    submission.uri.spec,
    "https://example.com/?q=foo",
    "Should have the expected search url."
  );
});

add_task(
  async function test_startup_with_existing_addon_with_startup_notification() {
    
    
    
    
    

    SearchService.reset();

    await SearchService.addEnginesFromExtension(extension.extension);

    let settingsWritten = promiseAfterSettings();
    await SearchService.init();
    await settingsWritten;

    let engine = await SearchService.getEngineByName("startup");
    Assert.ok(engine, "Should have loaded the engine");
    let submission = engine.getSubmission("foo");
    Assert.equal(
      submission.uri.spec,
      "https://example.com/?q=foo",
      "Should have the expected search url."
    );

    await extension.unload();
  }
);
