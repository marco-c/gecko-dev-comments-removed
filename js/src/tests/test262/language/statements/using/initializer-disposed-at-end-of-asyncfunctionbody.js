






























































asyncTest(async function () {

  var resource = {
      disposed: false,
      [Symbol.dispose]() {
          this.disposed = true;
      }
  };

  var releaseF1;
  var suspendFPromise1 = new Promise(function (resolve) { releaseF1 = resolve; });

  var releaseBody;
  var suspendBodyPromise = new Promise(function (resolve) { releaseBody = resolve; });

  var releaseF2;
  var suspendFPromise2 = new Promise(function (resolve) { releaseF2 = resolve; });

  async function f() {
      using _ = resource;
      await suspendFPromise1;
      releaseBody();
      await suspendFPromise2;
  }

  var resultPromise = f();

  var wasDisposedWhileSuspended1 = resource.disposed;

  releaseF1();
  await suspendBodyPromise;

  var wasDisposedWhileSuspended2 = resource.disposed;

  releaseF2();
  await resultPromise;

  var isDisposedAfterCompleted = resource.disposed;

  assert.sameValue(wasDisposedWhileSuspended1, false, 'Expected resource to not have been disposed while async function is suspended during await');
  assert.sameValue(wasDisposedWhileSuspended2, false, 'Expected resource to not have been disposed while async function is suspended during await');
  assert.sameValue(isDisposedAfterCompleted, true, 'Expected resource to have been disposed after async function completed');
});
