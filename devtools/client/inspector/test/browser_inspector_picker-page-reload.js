



"use strict";




const FRAME_URL = "https://example.com/document-builder.sjs?html=iframe";
const TEST_URL =
  `https://example.org/document-builder.sjs?html=` +
  encodeURI(
    `<h1>Pick target</h1><h2>Other element</h2><iframe></iframe><script>window.onload=()=>{document.querySelector("iframe").src = "${FRAME_URL}";}</script>`
  );

async function waitForIframeLoad() {
  const iframeBC = await SpecialPowers.spawn(
    gBrowser.selectedBrowser,
    [],
    function () {
      return content.document.querySelector("iframe").browsingContext;
    }
  );
  await SpecialPowers.spawn(iframeBC, [FRAME_URL], async function (url) {
    if (
      content.document.readyState == "complete" &&
      content.location.href == url
    ) {
      return null;
    }
    return new Promise(resolve => {
      content.addEventListener("load", resolve, { once: true });
    });
  });
}

add_task(async () => {
  let { inspector, toolbox, highlighterTestFront } =
    await openInspectorForURL(TEST_URL);
  await waitForIframeLoad();

  info(
    "Start the picker and hover an element to populate the picker hovered node reference"
  );
  await startPicker(toolbox);
  await hoverElement(inspector, "iframe");

  const HIGHLIGHTER_TYPE = inspector.highlighters.TYPES.BOXMODEL;
  const { getActiveHighlighter } = getHighlighterTestHelpers(inspector);

  ok(getActiveHighlighter(HIGHLIGHTER_TYPE), "Boxmodel highlighter is shown.");
  ok(
    await highlighterTestFront.assertHighlightedNode("iframe"),
    "The highlighter is shown on the expected node"
  );

  
  
  const onReloaded = reloadSelectedTab();

  
  
  hoverElement(inspector, "h1");

  await onReloaded;

  
  await hoverElement(inspector, "h1");
  ok(getActiveHighlighter(HIGHLIGHTER_TYPE), "Boxmodel highlighter is shown.");

  highlighterTestFront = await getHighlighterTestFront(toolbox);
  ok(
    await highlighterTestFront.assertHighlightedNode("h1"),
    "The highlighter is shown on the expected node"
  );

  await stopPickerWithEscapeKey(toolbox);

  
  
  
  
  
  
  const onToolboxDestroyed = toolbox.once("destroyed");
  info("Try to close the toolbox via a key shortcut");
  if (Services.appinfo.OS == "Darwin") {
    EventUtils.synthesizeKey("i", { accelKey: true, altKey: true });
  } else {
    EventUtils.synthesizeKey("i", { accelKey: true, shiftKey: true });
  }
  await onToolboxDestroyed;
});
