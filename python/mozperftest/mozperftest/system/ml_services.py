


import os

from mozperftest.layers import Layer

ALLOWED_HOSTS = [
    
    
    "firefox.settings.services.mozilla.com",
    "firefox-settings-attachments.cdn.mozilla.net",
    "content-signature-2.cdn.mozilla.net",
    
    "model-hub.mozilla.org",
    
    "mlpa-prod-prod-mozilla.global.ssl.fastly.net",
]

PREFS = {
    "services.settings.server": "https://firefox.settings.services.mozilla.com/v1",
    "network.socket.allowed_nonlocal_domains": ",".join(ALLOWED_HOSTS),
}


class MLServices(Layer):
    """
    Define environment variable values to allow ML Services to be accessed by tests.
    """

    name = "ml-services"
    activated = True

    def setup(self):
        os.environ["MOZ_REMOTE_SETTINGS_DEVTOOLS"] = "1"

    def run(self, metadata):
        metadata.get_options("browser_prefs").update(PREFS)
        for host in ALLOWED_HOSTS:
            self.info(f"[ml-services] allowed host: {host}")

        return metadata

    def teardown(self):
        os.environ.pop("MOZ_REMOTE_SETTINGS_DEVTOOLS", None)
