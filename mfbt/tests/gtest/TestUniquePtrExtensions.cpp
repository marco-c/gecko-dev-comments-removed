





#include "gtest/gtest.h"

#include "mozilla/UniquePtrExtensions.h"
#ifdef XP_UNIX
#  include "fcntl.h"
#  include "unistd.h"
#endif
#ifdef XP_WIN
#  include "namedpipeapi.h"
#endif

using namespace mozilla;

static UniqueFileHandle CreateArbitraryFileHandle() {
#ifdef XP_UNIX
  return UniqueFileHandle(dup(0));
#endif
#ifdef XP_WIN
  UniqueFileHandle hnd0, hnd1;
  if (::CreatePipe(getter_Transfers(hnd0), getter_Transfers(hnd1),
                    nullptr,
                    0)) {
    return hnd0;
  }
  return nullptr;
#endif
}


TEST(MFBT_UniquePtrExtensions, UFH_DupNull)
{
  UniqueFileHandle fd0;
  ASSERT_FALSE(fd0);
  UniqueFileHandle fd1 = DuplicateFileHandle(fd0);
  EXPECT_FALSE(fd1);
}



TEST(MFBT_UniquePtrExtensions, UFH_DupBasic)
{
  UniqueFileHandle fd0 = CreateArbitraryFileHandle();
  ASSERT_TRUE(fd0);
  UniqueFileHandle fd1 = DuplicateFileHandle(fd0);
  EXPECT_TRUE(fd1);
  EXPECT_NE(fd0.get(), fd1.get());
}

#ifdef XP_UNIX


TEST(MFBT_UniquePtrExtensions, UFH_SetCloExec)
{
  UniqueFileHandle fd0(dup(0));
  ASSERT_TRUE(fd0);
  int rv0 = fcntl(fd0.get(), F_GETFD);
  ASSERT_GE(rv0, 0);
  EXPECT_FALSE(rv0 & FD_CLOEXEC);

  SetCloseOnExec(fd0);
  ASSERT_TRUE(fd0);
  int rv1 = fcntl(fd0.get(), F_GETFD);
  ASSERT_GE(rv1, 0);
  EXPECT_TRUE(rv1 & FD_CLOEXEC);
}


TEST(MFBT_UniquePtrExtensions, UFH_DupCloExec)
{
  UniqueFileHandle fd0(dup(0));
  ASSERT_TRUE(fd0);
  int rv0 = fcntl(fd0.get(), F_GETFD);
  ASSERT_GE(rv0, 0);
  EXPECT_FALSE(rv0 & FD_CLOEXEC);

  UniqueFileHandle fd1 = DuplicateFileHandle(fd0);
  ASSERT_TRUE(fd1);
  int rv1 = fcntl(fd1.get(), F_GETFD);
  ASSERT_GE(rv1, 0);
  EXPECT_TRUE(rv1 & FD_CLOEXEC);
}

#endif  
